<style>
    /* ç¡®ä¿ç­›é€‰å™¨å®Œå…¨å¯¹é½ */
    #statusFilter, #timeRangeFilter {
        height: 40px !important;
        line-height: 1 !important;
        vertical-align: middle !important;
        box-sizing: border-box !important;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <div class="space-y-6" id="projectsContainer">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">é¡¹ç›®ç®¡ç†</h1>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">ç®¡ç†ä½ çš„å­¦ä¹ é¡¹ç›®ï¼Œè·Ÿè¸ªè¿›åº¦å’ŒçŠ¶æ€</p>
            </div>
            <div class="mt-4 sm:mt-0 flex space-x-2">
                <button id="importExcelBtn" 
                    class="hidden inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700">
                    <span class="mr-2">ğŸ“Š</span>
                    å¯¼å…¥Excel
                </button>
                <button id="createProjectBtn" 
                    class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700">
                    <span class="mr-2">â•</span>
                    æ–°å»ºé¡¹ç›®
                </button>
            </div>
        </div>

        <!-- æ‰¹é‡æ“ä½œå’Œå¯¼å‡º -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2">
            <div class="flex items-center space-x-2 mb-2 sm:mb-0">
                <!-- ç§»é™¤å…¨é€‰æ¡†å’Œæ‰¹é‡æ“ä½œæŒ‰é’® -->
            </div>
            <div>
                <button id="exportProjectsBtn" class="hidden px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">å¯¼å‡ºExcel</button>
            </div>
        </div>

        <!-- é¡¹ç›®åˆ—è¡¨ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">é¡¹ç›®åˆ—è¡¨</h3>
                    <!-- éšè—é‡å¤çš„æŒ‰é’®ï¼Œåªä¿ç•™é¡µé¢é¡¶éƒ¨çš„#createProjectBtn -->
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                é¡¹ç›®åç§°
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                æè¿°
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                çŠ¶æ€
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                é¢„ä¼°æ—¶é—´
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                åˆ›å»ºæ—¶é—´
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                æ“ä½œ
                            </th>
                        </tr>
                    </thead>
                    <tbody id="projectsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- é¡¹ç›®æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div id="projectsEmptyState" class="hidden text-center py-12">
                    <div class="text-gray-400 dark:text-gray-500">
                        <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">æš‚æ— é¡¹ç›®</p>
                        <p class="text-sm mb-4">å¼€å§‹åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå­¦ä¹ é¡¹ç›®å§ï¼</p>
                        <!-- éšè—é‡å¤çš„æŒ‰é’®ï¼Œåªä¿ç•™é¡µé¢é¡¶éƒ¨çš„#createProjectBtn -->
                    </div>
                </div>
                
                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="projectsLoadingState" class="text-center py-12">
                    <div class="inline-flex items-center text-gray-500 dark:text-gray-400">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
            
            <!-- åˆ†é¡µå¯¼èˆª -->
            <div id="projectsPagination" class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 hidden">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700 dark:text-gray-300">
                        æ˜¾ç¤º <span id="projectsStartIndex">1</span> åˆ° <span id="projectsEndIndex">10</span> æ¡ï¼Œå…± <span id="projectsTotal">0</span> æ¡è®°å½•
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="projectsPrevBtn" class="px-3 py-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸Šä¸€é¡µ
                        </button>
                        <span id="projectsPageInfo" class="px-3 py-1 text-sm text-gray-700 dark:text-gray-300"></span>
                        <button id="projectsNextBtn" class="px-3 py-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸‹ä¸€é¡µ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨åˆ†æåŒºåŸŸ -->
        <div id="analyticsSection" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hidden">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6 gap-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">ğŸ“ˆ é¡¹ç›®æ•°æ®åˆ†æ</h2>
                <div class="flex flex-wrap items-center gap-6">
                    <!-- ç­›é€‰å™¨ -->
                    <select id="statusFilter" class="h-10 border rounded-lg px-4 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white min-w-[160px] focus:ring-2 focus:ring-primary-500 focus:border-primary-500 leading-none flex-shrink-0">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="paused">å·²æš‚åœ</option>
                    </select>
                    <select id="timeRangeFilter" class="h-10 border rounded-lg px-4 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white min-w-[160px] focus:ring-2 focus:ring-primary-500 focus:border-primary-500 leading-none flex-shrink-0">
                        <option value="all">å…¨éƒ¨æ—¶é—´</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="quarter">æœ¬å­£åº¦</option>
                        <option value="year">æœ¬å¹´</option>
                    </select>
                </div>
            </div>
            
            <!-- å›¾è¡¨ç½‘æ ¼ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h3 class="text-md font-medium text-gray-900 dark:text-white mb-3">é¡¹ç›®çŠ¶æ€åˆ†å¸ƒ</h3>
                    <div style="height: 250px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                
                <!-- é¡¹ç›®åˆ†ç±»åˆ†å¸ƒ -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h3 class="text-md font-medium text-gray-900 dark:text-white mb-3">é¡¹ç›®åˆ†ç±»åˆ†å¸ƒ</h3>
                    <div style="height: 250px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                
                <!-- é¡¹ç›®è¿›åº¦è¶‹åŠ¿ -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h3 class="text-md font-medium text-gray-900 dark:text-white mb-3">é¡¹ç›®è¿›åº¦è¶‹åŠ¿</h3>
                    <div style="height: 250px;">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
                
                <!-- é¡¹ç›®å®Œæˆæ—¶é—´åˆ†å¸ƒ -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h3 class="text-md font-medium text-gray-900 dark:text-white mb-3">é¡¹ç›®å®Œæˆæ—¶é—´åˆ†å¸ƒ</h3>
                    <div style="height: 250px;">
                        <canvas id="durationChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 dark:bg-blue-800 rounded-lg">
                            <span class="text-xl">ğŸ“Š</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-blue-600 dark:text-blue-400">æ€»é¡¹ç›®æ•°</p>
                            <p class="text-2xl font-bold text-blue-900 dark:text-blue-100" id="totalProjectsCount">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 dark:bg-green-800 rounded-lg">
                            <span class="text-xl">âœ…</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-green-600 dark:text-green-400">å·²å®Œæˆ</p>
                            <p class="text-2xl font-bold text-green-900 dark:text-green-100" id="completedProjectsCount">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 dark:bg-yellow-800 rounded-lg">
                            <span class="text-xl">â±ï¸</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-yellow-600 dark:text-yellow-400">å¹³å‡è¿›åº¦</p>
                            <p class="text-2xl font-bold text-yellow-900 dark:text-yellow-100" id="avgProgress">0%</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 dark:bg-purple-800 rounded-lg">
                            <span class="text-xl">ğŸ“ˆ</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-purple-600 dark:text-purple-400">å®Œæˆç‡</p>
                            <p class="text-2xl font-bold text-purple-900 dark:text-purple-100" id="completionRate">0%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡¹ç›®å®Œæˆç»Ÿè®¡å¡ç‰‡ -->
        <div id="completionStatsCard" class="mt-8 p-6 bg-white rounded-lg shadow border border-gray-100">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">é¡¹ç›®å®Œæˆç»Ÿè®¡</h3>
            <div class="flex items-center space-x-2">
              <select id="projectSelect" class="border rounded px-2 py-1 text-sm">
                <option value="">é€‰æ‹©é¡¹ç›®</option>
              </select>
              <select id="statsRangeSelect" class="border rounded px-2 py-1 text-sm">
                <option value="week">æœ¬å‘¨</option>
                <option value="month">æœ¬æœˆ</option>
                <option value="quarter">æœ¬å­£åº¦</option>
                <option value="year">æœ¬å¹´</option>
              </select>
            </div>
          </div>
          <div id="completionStatsSummary" class="mb-4 text-sm text-gray-600"></div>
          
          <!-- æŸ±çŠ¶å›¾å®¹å™¨ -->
          <div class="mb-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">å­¦ä¹ æ—¶é•¿ç»Ÿè®¡</h4>
            <div class="w-full h-64">
              <canvas id="completionStatsBarChart"></canvas>
            </div>
          </div>
          
          <!-- ç»Ÿè®¡è¡¨æ ¼ -->
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border">
              <thead>
                <tr class="bg-gray-50">
                  <th class="px-3 py-2 border text-center">æ—¥æœŸ</th>
                  <th class="px-3 py-2 border text-center">å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)</th>
                  <th class="px-3 py-2 border text-center">è¯„çº§</th>
                  <th class="px-3 py-2 border text-center">æŒ‰æ—¶å®Œæˆ</th>
                </tr>
              </thead>
              <tbody id="completionStatsTableBody">
                <!-- åŠ¨æ€å¡«å…… -->
              </tbody>
            </table>
          </div>
        </div>
    </div>

    <!-- Excelå¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">å¯¼å…¥Excelæ–‡ä»¶</h2>
                    <button id="closeImportModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">é€‰æ‹©Excelæ–‡ä»¶</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div class="mb-4">
                        <a href="/excel_templates/å­¦ä¹ é¡¹ç›®è®°å½•ç¤ºä¾‹.xlsx" download 
                           class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm">
                            ğŸ“¥ ä¸‹è½½Excelæ¨¡æ¿
                        </a>
                    </div>
                    <div id="importMessage" class="mb-4"></div>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelImportBtn" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md">
                            å–æ¶ˆ
                        </button>
                        <button id="confirmImportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            å¯¼å…¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç°ä»£åŒ–æ–°å»ºé¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="createProjectModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm transition-all duration-300 hidden">
        <div class="relative w-full mx-2 sm:mx-auto" style="max-width: 28rem; width: 100%;">
            <!-- å¼¹çª—ä¸»ä½“ -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl transition-all duration-300 scale-95 opacity-0 max-h-[90vh] flex flex-col overflow-hidden" style="width: 100%;">
                <!-- å¤´éƒ¨ -->
                <div class="flex items-center justify-between px-6 pt-6 pb-2 border-b border-gray-100 dark:border-gray-800 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">åˆ›å»ºæ–°é¡¹ç›®</h3>
                    </div>
                    <button id="cancelCreateBtn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                        <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- å†…å®¹åŒº - å¯æ»šåŠ¨ -->
                <form id="createProjectForm" class="px-6 py-6 flex-1 overflow-y-auto" style="min-height:0;max-height:calc(90vh - 64px - 72px);">
                    <div class="space-y-4">
                        <!-- é¡¹ç›®åç§° -->
                        <div>
                            <label for="projectName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                é¡¹ç›®åç§° <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="projectName" name="name" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                   placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" autocomplete="off">
                        </div>

                        <!-- é¡¹ç›®æè¿° -->
                        <div>
                            <label for="projectDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                é¡¹ç›®æè¿°
                            </label>
                            <div class="relative">
                                <textarea id="projectDescription" name="description" rows="3" maxlength="50"
                                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-none"
                                          placeholder="è¯·è¾“å…¥é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰ï¼Œæœ€å¤š50å­—ã€‚"
                                          style="resize: none;"></textarea>
                                <div class="absolute bottom-2 right-2 text-xs text-gray-400 dark:text-gray-500 pointer-events-none">
                                    <span id="descriptionCharCount">0</span>/50
                                </div>
                            </div>
                        </div>

                        <!-- é¡¹ç›®ç±»å‹ - å›ºå®šä¸ºè‡ªå®šä¹‰ -->
                        <div>
                            <label for="projectType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                é¡¹ç›®ç±»å‹
                            </label>
                            <select id="projectType" name="project_type" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                    disabled>
                                <option value="custom" selected>è‡ªå®šä¹‰</option>
                            </select>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">ä½¿ç”¨è‡ªå®šä¹‰è¯„çº§æ ‡å‡†</p>
                        </div>

                        <!-- é¢„ä¼°æ—¶é—´ -->
                        <div>
                            <label for="projectEstimatedHours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                é¢„ä¼°æ—¶é—´ <span class="text-red-500">*</span>
                            </label>
                            <select id="projectEstimatedHours" name="estimated_hours" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                                <option value="">è¯·é€‰æ‹©é¢„ä¼°æ—¶é—´</option>
                                <option value="15">15åˆ†é’Ÿ</option>
                                <option value="20">20åˆ†é’Ÿ</option>
                                <option value="30">30åˆ†é’Ÿ</option>
                                <option value="40">40åˆ†é’Ÿ</option>
                                <option value="60">60åˆ†é’Ÿ</option>
                                <option value="90">90åˆ†é’Ÿ</option>
                                <option value="120">120åˆ†é’Ÿ</option>
                                <option value="150">150åˆ†é’Ÿ</option>
                                <option value="180">180åˆ†é’Ÿ</option>
                            </select>
                        </div>

                        <!-- è‡ªå®šä¹‰è¯„çº§è®¾ç½® - å§‹ç»ˆæ˜¾ç¤º -->
                        <div id="customRatingSettings" class="space-y-3 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">è‡ªå®šä¹‰è¯„çº§æ ‡å‡†</h4>
                            
                            <!-- ä¼˜ç§€è¯„çº§ -->
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 dark:text-gray-400 w-12">ä¼˜ç§€:</label>
                                <input type="number" id="excellentTime" name="excellent_time" min="1" max="300"
                                       class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       placeholder="30" value="30">
                                <span class="text-sm text-gray-500 dark:text-gray-400">åˆ†é’Ÿä»¥å†…</span>
                                <span class="text-lg">ğŸ˜Š</span>
                            </div>
                            
                            <!-- è‰¯è¯„çº§ -->
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 dark:text-gray-400 w-12">è‰¯:</label>
                                <input type="number" id="goodTimeMin" name="good_time_min" min="1" max="300"
                                       class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       placeholder="30" value="30">
                                <span class="text-sm text-gray-500 dark:text-gray-400">-</span>
                                <input type="number" id="goodTimeMax" name="good_time_max" min="1" max="300"
                                       class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       placeholder="60" value="60">
                                <span class="text-sm text-gray-500 dark:text-gray-400">åˆ†é’Ÿ</span>
                                <span class="text-lg">ğŸ˜Š</span>
                            </div>
                            
                            <!-- ä¸­è¯„çº§ -->
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 dark:text-gray-400 w-12">ä¸­:</label>
                                <input type="number" id="mediumTimeMin" name="medium_time_min" min="1" max="300"
                                       class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       placeholder="60" value="60">
                                <span class="text-sm text-gray-500 dark:text-gray-400">-</span>
                                <input type="number" id="mediumTimeMax" name="medium_time_max" min="1" max="300"
                                       class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       placeholder="90" value="90">
                                <span class="text-sm text-gray-500 dark:text-gray-400">åˆ†é’Ÿ</span>
                                <span class="text-lg">ğŸ’ª</span>
                            </div>
                            
                            <!-- å·®è¯„çº§ -->
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 dark:text-gray-400 w-12">å·®:</label>
                                <input type="number" id="poorTimeMin" name="poor_time_min" min="1" max="300"
                                       class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                       placeholder="90" value="90">
                                <span class="text-sm text-gray-500 dark:text-gray-400">åˆ†é’Ÿä»¥ä¸Š</span>
                                <span class="text-lg">ğŸ˜ </span>
                            </div>
                        </div>

                        <!-- æ™ºèƒ½è¯„çº§é¢„è§ˆ -->
                        <div id="ratingPreview" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                æ™ºèƒ½è¯„çº§é¢„è§ˆ
                            </label>
                            <div id="ratingDisplay" class="px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white">
                                <!-- è¯„çº§å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>

                    <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="createProjectMessage" class="mt-4"></div>
                    
                    <!-- æŒ‰é’®åŒº - ç§»åˆ°è¡¨å•å†…éƒ¨ -->
                    <div class="flex flex-col-reverse sm:flex-row gap-4 pt-4 border-t border-gray-100 dark:border-gray-800 flex-shrink-0">
                        <button type="button" id="cancelCreateBtn2" 
                                class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200 font-medium">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" id="confirmCreateBtn" 
                                class="w-full sm:w-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            åˆ›å»ºé¡¹ç›®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘é¡¹ç›®å¼¹çª— -->
<div id="editProjectModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm transition-all duration-300 hidden p-4">
    <div class="relative w-full mx-2 sm:mx-auto" style="max-width: 32rem; width: 100%; max-height: 90vh;">
        <!-- å¼¹çª—ä¸»ä½“ -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl transition-all duration-300 scale-95 opacity-0 flex flex-col" style="width: 100%; max-height: 90vh;">
            <!-- å¤´éƒ¨ -->
            <div class="flex items-center justify-between px-6 pt-6 pb-2 border-b border-gray-100 dark:border-gray-800 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">ç¼–è¾‘é¡¹ç›®</h3>
                </div>
                <button id="closeEditProjectModalBtn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                    <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å†…å®¹åŒº -->
            <form id="editProjectForm" class="px-6 py-6 flex-1 overflow-y-auto">
                <div class="space-y-4">
                    <!-- é¡¹ç›®åç§° -->
                    <div>
                        <label for="editProjectName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            é¡¹ç›®åç§° <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="editProjectName" name="name" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                               placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" autocomplete="off">
                        <div id="editProjectNameError" class="text-red-500 text-xs mt-1 hidden"></div>
                    </div>

                    <!-- é¡¹ç›®æè¿° -->
                    <div>
                        <label for="editProjectDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            é¡¹ç›®æè¿° <span class="text-gray-500 text-xs">(å¯é€‰ï¼Œæœ€å¤š50å­—)</span>
                        </label>
                        <textarea id="editProjectDescription" name="description" rows="3" maxlength="50"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-none"
                                  placeholder="è¯·è¾“å…¥é¡¹ç›®æè¿°"></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500 dark:text-gray-400">ç¦ç”¨æ‹–æ‹½è°ƒæ•´å¤§å°</span>
                            <span id="editProjectDescriptionCount" class="text-xs text-gray-500 dark:text-gray-400">0/50</span>
                        </div>
                    </div>

                    <!-- é¢„ä¼°æ—¶é—´ -->
                    <div>
                        <label for="editProjectEstimatedHours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            é¢„ä¼°æ—¶é—´ <span class="text-red-500">*</span>
                        </label>
                        <select id="editProjectEstimatedHours" name="estimated_hours" required
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            <option value="">è¯·é€‰æ‹©é¢„ä¼°æ—¶é—´</option>
                            <option value="15">15åˆ†é’Ÿ</option>
                            <option value="20">20åˆ†é’Ÿ</option>
                            <option value="30">30åˆ†é’Ÿ</option>
                            <option value="40">40åˆ†é’Ÿ</option>
                            <option value="60">60åˆ†é’Ÿ</option>
                            <option value="90">90åˆ†é’Ÿ</option>
                            <option value="120">120åˆ†é’Ÿ</option>
                            <option value="150">150åˆ†é’Ÿ</option>
                            <option value="180">180åˆ†é’Ÿ</option>
                        </select>
                    </div>

                    <!-- é¡¹ç›®çŠ¶æ€ -->
                    <div>
                        <label for="editProjectStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            é¡¹ç›®çŠ¶æ€
                        </label>
                        <select id="editProjectStatus" name="status"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            <option value="not_started">æœªå¼€å§‹</option>
                            <option value="in_progress">è¿›è¡Œä¸­</option>
                            <option value="paused">å·²æš‚åœ</option>
                            <option value="completed">å·²å®Œæˆ</option>
                        </select>
                    </div>
                </div>

                <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="editProjectMessage" class="mt-4"></div>
            </form>

            <!-- æŒ‰é’®åŒº -->
            <div class="flex flex-col-reverse sm:flex-row gap-4 p-6 border-t border-gray-100 dark:border-gray-800 flex-shrink-0">
                <button type="button" id="cancelEditProjectBtn" 
                        class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200 font-medium">
                    å–æ¶ˆ
                </button>
                <button type="submit" id="saveEditProjectBtn" 
                        class="w-full sm:w-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cal-Heatmap æ—¥å†çƒ­åŠ›å›¾æ ·å¼ -->
<link rel="stylesheet" href="/assets/js/lib/cal-heatmap.min.css">

<!-- é¡¹ç›®å®Œæˆæƒ…å†µç»Ÿè®¡çƒ­åŠ›å›¾å®¹å™¨ -->
<div id="calendar-heatmap" class="my-6"></div>

<script src="/assets/js/lib/cal-heatmap.min.js"></script>
<script>
  // ç¤ºä¾‹é™æ€æ•°æ®ï¼Œåç»­å¯æ›¿æ¢ä¸ºåç«¯æ¥å£è¿”å›çš„å­¦ä¹ æ—¶é•¿æ•°æ®
  const heatmapData = {
    '2025-07-01': 60,
    '2025-07-02': 120,
    '2025-07-03': 90,
    '2025-07-04': 0,
    '2025-07-05': 180,
    '2025-07-06': 30,
    '2025-07-07': 150,
    '2025-07-08': 80,
    '2025-07-09': 0,
    '2025-07-10': 60
  };
  // è½¬æ¢ä¸º cal-heatmap éœ€è¦çš„æ ¼å¼
  const calData = {};
  Object.keys(heatmapData).forEach(date => {
    calData[new Date(date).getTime() / 1000] = heatmapData[date];
  });
  // æ¸²æŸ“æ—¥å†çƒ­åŠ›å›¾
  const cal = new CalHeatmap();
  cal.paint({
    data: {
      source: calData,
      type: 'json'
    },
    range: 1,
    domain: { type: 'month', label: { position: 'top', text: 'å­¦ä¹ æ—¥å†' } },
    subDomain: { type: 'day', label: 'D', radius: 4 },
    scale: { color: { type: 'linear', scheme: 'YlOrRd', domain: [0, 180] } },
    legend: [30, 60, 90, 120, 150, 180],
    itemSelector: '#calendar-heatmap',
    tooltip: {
      enabled: true,
      text: function(date, value) {
        return `${date.toLocaleDateString()} å­¦ä¹ æ—¶é•¿ï¼š${value || 0} åˆ†é’Ÿ`;
      }
    }
  });
</script>

<script>
// é¡¹ç›®ç®¡ç†åº”ç”¨
class ProjectsApp {
    constructor() {
        console.log('ProjectsApp æ„é€ å‡½æ•°è¢«è°ƒç”¨');
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
        if (window.projectsAppInitialized) {
            console.log('ProjectsApp å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
            return;
        }
        
        this.projects = [];
        this.currentPage = 1;
        this.pageSize = 10;
        this.charts = {};
        this.filters = {
            category: '',
            status: '',
            timeRange: 'all'
        };
        
        // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å›¾è¡¨
        this.cleanupCharts();
        
        this.init();
        
        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
        window.projectsAppInitialized = true;
    }
    
    init() {
        console.log('ProjectsApp åˆå§‹åŒ–å¼€å§‹');
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡é¡¹ç›®æ•°æ®
        if (this.projects.length > 0) {
            console.log('é¡¹ç›®æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡é‡æ–°åŠ è½½');
            this.setupEventListeners();
            return;
        }
        
        this.loadProjects();
        this.setupEventListeners();
        console.log('ProjectsApp åˆå§‹åŒ–å®Œæˆ');
    }
    
    async loadProjects(page = 1) {
        // é˜²æ­¢é‡å¤åŠ è½½
        if (this.isLoading) {
            console.log('é¡¹ç›®æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
            return;
        }
        
        this.isLoading = true;
        this.currentPage = page;
        
        try {
            this.showLoading();
            
            // è°ƒç”¨APIæ—¶ä¼ é€’åˆ†é¡µå‚æ•°
            const url = `/api/projects?page=${page}&limit=${this.pageSize}`;
            
            // åœ¨demoæ¨¡å¼ä¸‹æ£€æŸ¥æ˜¯å¦è¢«æ‹¦æˆª
            if (window.isDemo && window.interceptDemoModeAPI) {
                if (!window.interceptDemoModeAPI(url, 'GET')) {
                    this.hideLoading();
                    this.isLoading = false;
                    return;
                }
            }
            
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                this.projects = data.projects || [];
                this.totalProjects = data.pagination?.total || this.projects.length;
                this.totalPages = data.pagination?.pages || Math.ceil(this.totalProjects / this.pageSize);
                
                // å§‹ç»ˆæ˜¾ç¤ºé¡¹ç›®åˆ†æå¡ç‰‡
                this.showAnalyticsSection();
                
                if (this.projects.length === 0) {
                    this.showEmptyState();
                } else {
                    this.showProjectsTable();
                    this.renderProjects();
                }
            } else {
                throw new Error('åŠ è½½é¡¹ç›®å¤±è´¥');
            }
        } catch (error) {
            console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
            this.showError('åŠ è½½é¡¹ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            this.showEmptyState();
            // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºé¡¹ç›®åˆ†æå¡ç‰‡
            this.showAnalyticsSection();
        } finally {
            this.hideLoading();
            this.isLoading = false;
        }
    }
    
    renderProjects() {
        const tbody = document.getElementById('projectsTableBody');
        
        // ç›´æ¥æ¸²æŸ“å½“å‰é¡µçš„é¡¹ç›®ï¼Œä¸éœ€è¦å®¢æˆ·ç«¯åˆ†é¡µ
        tbody.innerHTML = this.projects.map(project => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200" data-project-id="${project.id}">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                                <svg class="h-6 w-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${project.name}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 dark:text-white max-w-xs truncate" title="${this.escapeHtml(project.description) || 'æš‚æ— æè¿°'}">
                        ${this.escapeHtml(project.description) || 'æš‚æ— æè¿°'}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        project.status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' :
                        project.status === 'in_progress' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300' :
                        project.status === 'paused' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' :
                        'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300'
                    }">
                        ${
                            project.status === 'completed' ? 'å·²å®Œæˆ' :
                            project.status === 'in_progress' ? 'è¿›è¡Œä¸­' :
                            project.status === 'paused' ? 'å·²æš‚åœ' :
                            'æœªå¼€å§‹'
                        }
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                    ${Math.round((project.estimated_hours || 0) * 60)} åˆ†é’Ÿ
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${new Date(project.created_at).toLocaleDateString('zh-CN')}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex items-center space-x-2">
                        <button onclick="projectsApp.editProject(${project.id})" 
                                class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 01-2-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="projectsApp.deleteProject(${project.id})" 
                                class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 01-1.995 1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        this.updatePagination();
        this.updateProjectSelect();
        
        // é¡¹ç›®æ•°æ®åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨åŠ è½½é¡¹ç›®å®Œæˆç»Ÿè®¡
        if (this.projects.length > 0) {
            setTimeout(() => {
                loadCompletionStats(this.projects[0].id, 'week');
            }, 100);
        }
    }
    
    setupEventListeners() {
        console.log('å¼€å§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
        
        // æ–°å»ºé¡¹ç›®æŒ‰é’®
        const createProjectBtn = document.getElementById('createProjectBtn');
        const createProjectBtn2 = document.getElementById('createProjectBtn2');
        
        console.log('createProjectBtn:', createProjectBtn);
        console.log('createProjectBtn2:', createProjectBtn2);
        
        if (createProjectBtn) {
            console.log('ä¸º createProjectBtn æ·»åŠ ç‚¹å‡»äº‹ä»¶');
            createProjectBtn.addEventListener('click', () => {
                console.log('createProjectBtn è¢«ç‚¹å‡»äº†ï¼');
                this.showCreateModal();
            });
        }
        
        if (createProjectBtn2) {
            console.log('ä¸º createProjectBtn2 æ·»åŠ ç‚¹å‡»äº‹ä»¶');
            createProjectBtn2.addEventListener('click', () => {
                console.log('æ–°å»ºé¡¹ç›®æŒ‰é’®è¢«ç‚¹å‡»');
                this.showCreateModal();
            });
        }
        
        // å–æ¶ˆæŒ‰é’®
        const cancelCreateBtn = document.getElementById('cancelCreateBtn');
        const cancelCreateBtn2 = document.getElementById('cancelCreateBtn2');
        
        if (cancelCreateBtn) {
            cancelCreateBtn.addEventListener('click', () => {
                this.hideCreateModal();
            });
        }
        
        if (cancelCreateBtn2) {
            cancelCreateBtn2.addEventListener('click', () => {
                this.hideCreateModal();
            });
        }
        
        // è¡¨å•æäº¤
        const createProjectForm = document.getElementById('createProjectForm');
        if (createProjectForm) {
            createProjectForm.addEventListener('submit', (e) => {
                this.createProject(e);
            });
        }
        
        // é¡¹ç›®åç§°å®æ—¶éªŒè¯
        const projectNameInput = document.getElementById('projectName');
        if (projectNameInput) {
            projectNameInput.addEventListener('input', (e) => {
                this.validateProjectName(e.target.value);
            });
            projectNameInput.addEventListener('blur', (e) => {
                this.validateProjectName(e.target.value);
            });
        }
        
        // é¡¹ç›®æè¿°å­—ç¬¦è®¡æ•°
        const projectDescriptionInput = document.getElementById('projectDescription');
        if (projectDescriptionInput) {
            projectDescriptionInput.addEventListener('input', (e) => {
                this.updateDescriptionCharCount(e.target.value);
            });
            // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
            this.updateDescriptionCharCount(projectDescriptionInput.value);
        }
        
        // é¢„ä¼°æ—¶é—´é€‰æ‹©äº‹ä»¶
        const estimatedHoursSelect = document.getElementById('projectEstimatedHours');
        if (estimatedHoursSelect) {
            estimatedHoursSelect.addEventListener('change', (e) => {
                this.updateRatingPreview();
            });
        }
        
        // è‡ªå®šä¹‰è¯„çº§è®¾ç½®äº‹ä»¶
        const customRatingInputs = ['excellentTime', 'goodTimeMin', 'goodTimeMax', 'mediumTimeMin', 'mediumTimeMax', 'poorTimeMin'];
        customRatingInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', () => {
                    this.updateRatingPreview();
                });
            }
        });
        
        // ç­›é€‰å™¨äº‹ä»¶
        // const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');
        const timeRangeFilter = document.getElementById('timeRangeFilter');
        
        // if (categoryFilter) {
        //     categoryFilter.addEventListener('change', () => {
        //         this.filters.category = categoryFilter.value;
        //         this.updateAnalytics();
        //     });
        // }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', () => {
                this.filters.status = statusFilter.value;
                this.updateAnalytics();
            });
        }
        
        if (timeRangeFilter) {
            timeRangeFilter.addEventListener('change', () => {
                this.filters.timeRange = timeRangeFilter.value;
                this.updateAnalytics();
            });
        }
        
        // åˆ†é¡µ
        const prevBtn = document.getElementById('projectsPrevBtn');
        const nextBtn = document.getElementById('projectsNextBtn');
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        
        if (prevBtn) prevBtn.addEventListener('click', () => this.prevPage());
        if (nextBtn) nextBtn.addEventListener('click', () => this.nextPage());
        if (pageSizeSelect) pageSizeSelect.addEventListener('change', (e) => this.changePageSize(parseInt(e.target.value)));
        
        // ç¼–è¾‘é¡¹ç›®å¼¹çª—äº‹ä»¶
        const closeEditProjectModalBtn = document.getElementById('closeEditProjectModalBtn');
        const cancelEditProjectBtn = document.getElementById('cancelEditProjectBtn');
        const editProjectForm = document.getElementById('editProjectForm');
        const editProjectDescriptionInput = document.getElementById('editProjectDescription');
        
        if (closeEditProjectModalBtn) {
            closeEditProjectModalBtn.addEventListener('click', () => {
                this.hideEditModal();
            });
        }
        
        if (cancelEditProjectBtn) {
            cancelEditProjectBtn.addEventListener('click', () => {
                this.hideEditModal();
            });
        }
        
        if (editProjectForm) {
            editProjectForm.addEventListener('submit', (e) => {
                this.saveEditProject(e);
            });
        }
        
        // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const saveEditProjectBtn = document.getElementById('saveEditProjectBtn');
        if (saveEditProjectBtn) {
            saveEditProjectBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.saveEditProject(e);
            });
        }
        
        if (editProjectDescriptionInput) {
            editProjectDescriptionInput.addEventListener('input', (e) => {
                this.updateEditDescriptionCharCount(e.target.value);
            });
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­ç¼–è¾‘å¼¹çª—
        const editProjectModal = document.getElementById('editProjectModal');
        if (editProjectModal) {
            editProjectModal.addEventListener('click', (e) => {
                if (e.target === editProjectModal) {
                    this.hideEditModal();
                }
            });
        }
        
        console.log('äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
    }
    
    // åˆ†é¡µæ–¹æ³•
    prevPage() {
        if (this.currentPage > 1) {
            this.loadProjects(this.currentPage - 1);
        }
    }
    
    nextPage() {
        if (this.currentPage < this.totalPages) {
            this.loadProjects(this.currentPage + 1);
        }
    }
    
    changePageSize(newSize) {
        this.pageSize = newSize;
        this.currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        this.loadProjects(1);
    }
    
    // å›¾è¡¨åˆ†æåŠŸèƒ½
    showAnalyticsSection() {
        const analyticsSection = document.getElementById('analyticsSection');
        if (analyticsSection) {
            analyticsSection.classList.remove('hidden');
            this.updateAnalytics();
        }
    }
    
    updateAnalytics() {
        this.updateStatistics();
        this.updateCharts();
    }
    
    updateStatistics() {
        const filteredProjects = this.getFilteredProjects();
        const total = filteredProjects.length;
        const completed = filteredProjects.filter(p => p.status === 'completed').length;
        const avgProgress = total > 0 ? Math.round(filteredProjects.reduce((sum, p) => sum + (p.progress || 0), 0) / total) : 0;
        const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        document.getElementById('totalProjectsCount').textContent = total;
        document.getElementById('completedProjectsCount').textContent = completed;
        document.getElementById('avgProgress').textContent = avgProgress + '%';
        document.getElementById('completionRate').textContent = completionRate + '%';
    }
    
    updateCharts() {
        const filteredProjects = this.getFilteredProjects();
        
        // çŠ¶æ€åˆ†å¸ƒå›¾
        this.updateStatusChart(filteredProjects);
        
        // åˆ†ç±»åˆ†å¸ƒå›¾
        this.updateCategoryChart(filteredProjects);
        
        // è¿›åº¦è¶‹åŠ¿å›¾
        this.updateProgressChart(filteredProjects);
        
        // å®Œæˆæ—¶é—´åˆ†å¸ƒå›¾
        this.updateDurationChart(filteredProjects);
    }
    
    updateStatusChart(projects) {
        const statusData = {
            active: projects.filter(p => p.status === 'active').length,
            completed: projects.filter(p => p.status === 'completed').length,
            paused: projects.filter(p => p.status === 'paused').length
        };
        
        const ctx = document.getElementById('statusChart');
        if (!ctx) {
            console.warn('statusChart canvas not found');
            return;
        }
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js æœªåŠ è½½ï¼Œè·³è¿‡å›¾è¡¨æ›´æ–°');
            return;
        }
        
        // é”€æ¯ç°æœ‰å›¾è¡¨
        if (this.charts.statusChart) {
            this.charts.statusChart.destroy();
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰Chartå®ä¾‹ä½¿ç”¨æ­¤canvas
        Chart.helpers.each(Chart.instances, (instance) => {
            if (instance.canvas.id === 'statusChart') {
                instance.destroy();
            }
        });
        
        this.charts.statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['è¿›è¡Œä¸­', 'å·²å®Œæˆ', 'å·²æš‚åœ'],
                datasets: [{
                    data: [statusData.active, statusData.completed, statusData.paused],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    updateCategoryChart(projects) {
        const categoryData = {};
        projects.forEach(project => {
            const category = project.category || 'other';
            categoryData[category] = (categoryData[category] || 0) + 1;
        });
        
        const ctx = document.getElementById('categoryChart');
        if (!ctx) {
            console.warn('categoryChart canvas not found');
            return;
        }
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js æœªåŠ è½½ï¼Œè·³è¿‡å›¾è¡¨æ›´æ–°');
            return;
        }
        
        // é”€æ¯ç°æœ‰å›¾è¡¨
        if (this.charts.categoryChart) {
            this.charts.categoryChart.destroy();
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰Chartå®ä¾‹ä½¿ç”¨æ­¤canvas
        Chart.helpers.each(Chart.instances, (instance) => {
            if (instance.canvas.id === 'categoryChart') {
                instance.destroy();
            }
        });
        
        this.charts.categoryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(categoryData).map(key => this.getCategoryText(key)),
                datasets: [{
                    data: Object.values(categoryData),
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    updateProgressChart(projects) {
        const progressRanges = {
            '0-25%': 0,
            '25-50%': 0,
            '50-75%': 0,
            '75-100%': 0
        };
        
        projects.forEach(project => {
            const progress = this.getProgress(project);
            if (progress <= 25) progressRanges['0-25%']++;
            else if (progress <= 50) progressRanges['25-50%']++;
            else if (progress <= 75) progressRanges['50-75%']++;
            else progressRanges['75-100%']++;
        });
        
        const ctx = document.getElementById('progressChart');
        if (!ctx) {
            console.warn('progressChart canvas not found');
            return;
        }
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js æœªåŠ è½½ï¼Œè·³è¿‡å›¾è¡¨æ›´æ–°');
            return;
        }
        
        // é”€æ¯ç°æœ‰å›¾è¡¨
        if (this.charts.progressChart) {
            this.charts.progressChart.destroy();
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰Chartå®ä¾‹ä½¿ç”¨æ­¤canvas
        Chart.helpers.each(Chart.instances, (instance) => {
            if (instance.canvas.id === 'progressChart') {
                instance.destroy();
            }
        });
        
        this.charts.progressChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(progressRanges),
                datasets: [{
                    label: 'é¡¹ç›®æ•°é‡',
                    data: Object.values(progressRanges),
                    backgroundColor: '#10b981'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    
    updateDurationChart(projects) {
        const durationRanges = {
            '0-1å¤©': 0,
            '1-3å¤©': 0,
            '3-7å¤©': 0,
            '7-30å¤©': 0,
            '30å¤©+': 0
        };
        
        projects.forEach(project => {
            const startDate = new Date(project.start_date);
            const endDate = project.end_date ? new Date(project.end_date) : new Date();
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            if (days <= 1) durationRanges['0-1å¤©']++;
            else if (days <= 3) durationRanges['1-3å¤©']++;
            else if (days <= 7) durationRanges['3-7å¤©']++;
            else if (days <= 30) durationRanges['7-30å¤©']++;
            else durationRanges['30å¤©+']++;
        });
        
        const ctx = document.getElementById('durationChart');
        if (!ctx) {
            console.warn('durationChart canvas not found');
            return;
        }
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js æœªåŠ è½½ï¼Œè·³è¿‡å›¾è¡¨æ›´æ–°');
            return;
        }
        
        // é”€æ¯ç°æœ‰å›¾è¡¨
        if (this.charts.durationChart) {
            this.charts.durationChart.destroy();
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰Chartå®ä¾‹ä½¿ç”¨æ­¤canvas
        Chart.helpers.each(Chart.instances, (instance) => {
            if (instance.canvas.id === 'durationChart') {
                instance.destroy();
            }
        });
        
        this.charts.durationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(durationRanges),
                datasets: [{
                    label: 'é¡¹ç›®æ•°é‡',
                    data: Object.values(durationRanges),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    
    getFilteredProjects() {
        let filtered = [...this.projects];
        
        if (this.filters.status) {
            filtered = filtered.filter(p => p.status === this.filters.status);
        }
        
        if (this.filters.timeRange !== 'all') {
            const now = new Date();
            let startDate;
            
            switch (this.filters.timeRange) {
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
            }
            
            filtered = filtered.filter(p => new Date(p.created_at) >= startDate);
        }
        
        return filtered;
    }
    
    updateFilter(type, value) {
        this.filters[type] = value;
        this.updateAnalytics();
    }
    
    // æ˜¾ç¤ºçŠ¶æ€æ§åˆ¶
    showLoading() {
        document.getElementById('projectsLoadingState').classList.remove('hidden');
    }
    
    hideLoading() {
        document.getElementById('projectsLoadingState').classList.add('hidden');
    }
    
    showEmptyState() {
        document.getElementById('projectsEmptyState').classList.remove('hidden');
        document.getElementById('projectsTableBody').innerHTML = '';
        document.getElementById('projectsPagination').classList.add('hidden');
    }
    
    showProjectsTable() {
        document.getElementById('projectsEmptyState').classList.add('hidden');
        document.getElementById('projectsTableBody').innerHTML = '';
    }
    
    updatePagination() {
        const startIndex = (this.currentPage - 1) * this.pageSize + 1;
        const endIndex = Math.min(this.currentPage * this.pageSize, this.totalProjects);
        
        document.getElementById('projectsTotal').textContent = this.totalProjects;
        document.getElementById('projectsStartIndex').textContent = this.totalProjects > 0 ? startIndex : 0;
        document.getElementById('projectsEndIndex').textContent = endIndex;
        document.getElementById('projectsPageInfo').textContent = `ç¬¬ ${this.currentPage} é¡µï¼Œå…± ${this.totalPages} é¡µ`;
        document.getElementById('projectsPrevBtn').disabled = this.currentPage === 1;
        document.getElementById('projectsNextBtn').disabled = this.currentPage === this.totalPages;
        
        // æ˜¾ç¤º/éšè—åˆ†é¡µ
        const pagination = document.getElementById('projectsPagination');
        if (this.totalProjects > 0) {
            pagination.classList.remove('hidden');
        } else {
            pagination.classList.add('hidden');
        }
    }
    
    updateProjectSelect() {
        const projectSelect = document.getElementById('projectSelect');
        if (!projectSelect) return;
        
        // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
        const currentValue = projectSelect.value;
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        projectSelect.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®</option>';
        
        // æ·»åŠ é¡¹ç›®é€‰é¡¹
        this.projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
        });
        
        // æ¢å¤é€‰ä¸­çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ªé¡¹ç›®
        if (currentValue && this.projects.some(p => p.id == currentValue)) {
            projectSelect.value = currentValue;
        } else if (this.projects.length > 0) {
            projectSelect.value = this.projects[0].id;
        }
    }
    
    // å·¥å…·æ–¹æ³•
    getCategoryText(category) {
        const categories = {
            programming: 'ç¼–ç¨‹',
            language: 'è¯­è¨€å­¦ä¹ ',
            design: 'è®¾è®¡',
            business: 'å•†ä¸š',
            other: 'å…¶ä»–'
        };
        return categories[category] || category;
    }
    
    getStatusText(status) {
        const statuses = {
            active: 'è¿›è¡Œä¸­',
            completed: 'å·²å®Œæˆ',
            paused: 'å·²æš‚åœ'
        };
        return statuses[status] || status;
    }
    
    getStatusClass(status) {
        const classes = {
            active: 'badge-primary',
            completed: 'badge-success',
            paused: 'badge-warning'
        };
        return classes[status] || 'badge-primary';
    }
    
    getProgress(project) {
        return Math.min(100, Math.max(0, project.progress || 0));
    }
    
    // åˆ›å»ºé¡¹ç›®åŠŸèƒ½
    showCreateModal() {
        const createProjectModal = document.getElementById('createProjectModal');
        const modalContent = createProjectModal?.querySelector('.bg-white, .dark\\:bg-gray-900');
        document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
        
        if (modalContent) {
            // é‡ç½®è¡¨å•å’ŒéªŒè¯çŠ¶æ€
            const form = document.getElementById('createProjectForm');
            if (form) {
                form.reset();
            }
            
            // æ¸…é™¤éªŒè¯æ¶ˆæ¯
            const messageDiv = document.getElementById('createProjectMessage');
            if (messageDiv) {
                messageDiv.innerHTML = '';
            }
            
            // é‡ç½®é¡¹ç›®åç§°è¾“å…¥æ¡†æ ·å¼
            const projectNameInput = document.getElementById('projectName');
            if (projectNameInput) {
                projectNameInput.classList.remove('border-red-500', 'border-green-500');
                projectNameInput.classList.add('border-gray-300', 'dark:border-gray-700');
            }
            
            // éšè—è¯„çº§é¢„è§ˆ
            const ratingPreview = document.getElementById('ratingPreview');
            if (ratingPreview) {
                ratingPreview.classList.add('hidden');
            }
            
            // æ·»åŠ é¢„ä¼°æ—¶é—´é€‰æ‹©ç›‘å¬å™¨
            const estimatedHoursInput = document.getElementById('projectEstimatedHours');
            if (estimatedHoursInput) {
                estimatedHoursInput.addEventListener('change', (e) => {
                    this.updateRatingPreview();
                });
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            createProjectModal.classList.remove('hidden');
            
            // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        } else {
            createProjectModal.classList.remove('hidden');
        }
    }
    
    // æ™ºèƒ½è¯„çº§ç³»ç»Ÿ
    updateRatingPreview() {
        const estimatedTime = document.getElementById('projectEstimatedHours').value;
        const ratingPreview = document.getElementById('ratingPreview');
        const ratingDisplay = document.getElementById('ratingDisplay');
        
        if (!estimatedTime) {
            ratingPreview.classList.add('hidden');
            return;
        }
        
        const rating = this.calculateRating('custom', parseInt(estimatedTime));
        ratingDisplay.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-lg">${rating.emoji}</span>
                <span class="font-medium">${rating.level}</span>
                <span class="text-sm text-gray-500">(${rating.description})</span>
            </div>
        `;
        ratingPreview.classList.remove('hidden');
    }
    
    // æ›´æ–°é¡¹ç›®æè¿°å­—ç¬¦è®¡æ•°
    updateDescriptionCharCount(text) {
        const charCount = text.length;
        const charCountElement = document.getElementById('descriptionCharCount');
        
        if (charCountElement) {
            charCountElement.textContent = charCount;
            
            // æ ¹æ®å­—ç¬¦æ•°æ”¹å˜é¢œè‰²
            if (charCount <= 39) {
                charCountElement.className = 'text-gray-400 dark:text-gray-500';
            } else if (charCount <= 44) {
                charCountElement.className = 'text-yellow-500 dark:text-yellow-400';
            } else {
                charCountElement.className = 'text-red-500 dark:text-red-400';
            }
        }
    }
    
    // éªŒè¯é¡¹ç›®åç§°
    validateProjectName(name) {
        const projectNameInput = document.getElementById('projectName');
        const messageDiv = document.getElementById('createProjectMessage');
        const submitBtn = document.getElementById('confirmCreateBtn');
        
        if (!projectNameInput || !messageDiv) return;
        
        const trimmedName = name.trim();
        
        // æ¸…é™¤ä¹‹å‰çš„æ ·å¼
        projectNameInput.classList.remove('border-red-500', 'border-green-500');
        projectNameInput.classList.add('border-gray-300', 'dark:border-gray-700');
        
        // æ¸…ç©ºæ¶ˆæ¯
        messageDiv.innerHTML = '';
        
        // é‡ç½®æäº¤æŒ‰é’®çŠ¶æ€
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        if (!trimmedName) {
            // åç§°ä¸ºç©ºï¼Œä¸æ˜¾ç¤ºéªŒè¯æ¶ˆæ¯
            return;
        }
        
        // æ£€æŸ¥é¡¹ç›®åç§°æ˜¯å¦å·²å­˜åœ¨
        const existingProject = this.projects.find(project => 
            project.name.toLowerCase().trim() === trimmedName.toLowerCase()
        );
        
        if (existingProject) {
            // åç§°é‡å¤
            projectNameInput.classList.remove('border-gray-300', 'dark:border-gray-700');
            projectNameInput.classList.add('border-red-500');
            messageDiv.innerHTML = `<div class="text-red-600 text-sm mt-2">âš ï¸ é¡¹ç›®åç§°"${trimmedName}"å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°</div>`;
            
            // ç¦ç”¨æäº¤æŒ‰é’®
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        } else {
            // åç§°å¯ç”¨
            projectNameInput.classList.remove('border-gray-300', 'dark:border-gray-700');
            projectNameInput.classList.add('border-green-500');
            messageDiv.innerHTML = `<div class="text-green-600 text-sm mt-2">âœ… é¡¹ç›®åç§°"${trimmedName}"å¯ç”¨</div>`;
        }
    }
    
    hideCreateModal() {
        const createProjectModal = document.getElementById('createProjectModal');
        const modalContent = createProjectModal?.querySelector('.bg-white, .dark\\:bg-gray-900');
        document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        
        if (modalContent) {
            // æ·»åŠ å…³é—­åŠ¨ç”»
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—æ¨¡æ€æ¡†
            setTimeout(() => {
                createProjectModal.classList.add('hidden');
            }, 300);
        } else {
            createProjectModal.classList.add('hidden');
        }
    }
    
    async createProject(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const messageDiv = document.getElementById('createProjectMessage');
        const submitBtn = document.getElementById('confirmCreateBtn');
        
        // ç¦ç”¨æäº¤æŒ‰é’®
        submitBtn.disabled = true;
        submitBtn.textContent = 'åˆ›å»ºä¸­...';
        
        try {
            // æ„å»ºè¯·æ±‚æ•°æ®
            const projectData = {
                name: formData.get('name'),
                description: formData.get('description') || '',
                project_type: formData.get('project_type'),
                estimated_hours: formData.get('estimated_hours') ? Math.round(parseFloat(formData.get('estimated_hours')) * 100) / 100 / 60 : null, // è½¬æ¢ä¸ºå°æ—¶ï¼Œä¿ç•™2ä½å°æ•°
                start_date: new Date().toISOString().split('T')[0], // é»˜è®¤ä»Šå¤©
                status: 'in_progress', // é»˜è®¤è¿›è¡Œä¸­
                category: 'other', // é»˜è®¤å…¶ä»–åˆ†ç±»
                difficulty_level: this.calculateDifficultyLevel(formData.get('estimated_hours')), // æ ¹æ®é¢„ä¼°æ—¶é—´è®¡ç®—éš¾åº¦ç­‰çº§
                rating_standards: JSON.stringify(this.getRatingStandards(formData.get('project_type'))) // è·å–è¯„çº§æ ‡å‡†å¹¶è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!projectData.name.trim()) {
                throw new Error('é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º');
            }
            
            if (!projectData.estimated_hours) {
                throw new Error('é¢„ä¼°æ—¶é—´ä¸èƒ½ä¸ºç©º');
            }
            
            // æ£€æŸ¥é¡¹ç›®åç§°æ˜¯å¦å·²å­˜åœ¨
            const existingProject = this.projects.find(project => 
                project.name.toLowerCase().trim() === projectData.name.toLowerCase().trim()
            );
            
            if (existingProject) {
                throw new Error(`é¡¹ç›®åç§°"${projectData.name}"å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`);
            }
            
            // éªŒè¯é¡¹ç›®åç§°æ ¼å¼ï¼ˆå¯é€‰ï¼šæ·»åŠ æ›´å¤šéªŒè¯è§„åˆ™ï¼‰
            if (projectData.name.trim().length < 2) {
                throw new Error('é¡¹ç›®åç§°è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
            }
            
            if (projectData.name.trim().length > 50) {
                throw new Error('é¡¹ç›®åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦');
            }
            
            messageDiv.innerHTML = '<div class="text-blue-600 text-sm">æ­£åœ¨åˆ›å»ºé¡¹ç›®...</div>';
            
            const url = '/api/projects';
            
            // åœ¨demoæ¨¡å¼ä¸‹æ£€æŸ¥æ˜¯å¦è¢«æ‹¦æˆª
            if (window.isDemo && window.interceptDemoModeAPI) {
                if (!window.interceptDemoModeAPI(url, 'POST')) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'åˆ›å»ºé¡¹ç›®';
                    return;
                }
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(projectData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                messageDiv.innerHTML = '<div class="text-green-600 text-sm">âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸï¼</div>';
                
                // ç«‹å³å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°åˆ—è¡¨
                this.hideCreateModal();
                try {
                    await this.loadProjects(1); // é‡æ–°åŠ è½½ç¬¬ä¸€é¡µ
                    
                    // è§¦å‘å…¨å±€äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–æ¨¡å—åˆ·æ–°é¡¹ç›®åˆ—è¡¨
                    const projectUpdateEvent = new CustomEvent('projectListUpdated', {
                        detail: { action: 'created', projectName: projectData.name }
                    });
                    window.dispatchEvent(projectUpdateEvent);
                    console.log('å·²è§¦å‘é¡¹ç›®åˆ—è¡¨æ›´æ–°äº‹ä»¶');
                    
                } catch (loadError) {
                    console.warn('é‡æ–°åŠ è½½é¡¹ç›®åˆ—è¡¨æ—¶å‡ºç°è­¦å‘Š:', loadError);
                    // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œå› ä¸ºé¡¹ç›®å·²ç»åˆ›å»ºæˆåŠŸ
                }
            } else {
                throw new Error(result.error || 'åˆ›å»ºé¡¹ç›®å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ›å»ºé¡¹ç›®å¤±è´¥:', error);
            messageDiv.innerHTML = `<div class="text-red-600 text-sm">âŒ ${error.message}</div>`;
        } finally {
            // æ¢å¤æäº¤æŒ‰é’®
            submitBtn.disabled = false;
            submitBtn.textContent = 'åˆ›å»ºé¡¹ç›®';
        }
    }
    
    // æ ¹æ®é¢„ä¼°æ—¶é—´è®¡ç®—éš¾åº¦ç­‰çº§
    calculateDifficultyLevel(minutes) {
        const minutesNum = parseInt(minutes) || 0;
        
        if (minutesNum <= 30) {
            return 1; // éå¸¸ç®€å•
        } else if (minutesNum <= 60) {
            return 2; // ç®€å•
        } else if (minutesNum <= 90) {
            return 3; // ä¸­ç­‰
        } else {
            return 4; // å›°éš¾
        }
    }
    
    // å¤„ç†é¡¹ç›®ç±»å‹å˜åŒ–
    handleProjectTypeChange(projectType) {
        const customRatingSettings = document.getElementById('customRatingSettings');
        
        if (projectType === 'custom') {
            customRatingSettings.classList.remove('hidden');
            // è®¾ç½®é»˜è®¤å€¼
            document.getElementById('excellentTime').value = '30';
            document.getElementById('goodTimeMin').value = '30';
            document.getElementById('goodTimeMax').value = '60';
            document.getElementById('mediumTimeMin').value = '60';
            document.getElementById('mediumTimeMax').value = '90';
            document.getElementById('poorTimeMin').value = '90';
        } else {
            customRatingSettings.classList.add('hidden');
        }
        
        this.updateRatingPreview();
    }
    
    editProject(id) {
        console.log('ç¼–è¾‘é¡¹ç›®:', id);
        this.currentEditProjectId = id;
        this.loadProjectForEdit(id);
    }
    
    async loadProjectForEdit(id) {
        try {
            const url = `/api/projects/${id}`;
            
            // åœ¨demoæ¨¡å¼ä¸‹æ£€æŸ¥æ˜¯å¦è¢«æ‹¦æˆª
            if (window.isDemo && window.interceptDemoModeAPI) {
                if (!window.interceptDemoModeAPI(url, 'GET')) {
                    return;
                }
            }
            
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                const project = data.project;
                this.fillEditForm(project);
                this.showEditModal();
            } else {
                throw new Error('åŠ è½½é¡¹ç›®è¯¦æƒ…å¤±è´¥');
            }
        } catch (error) {
            console.error('åŠ è½½é¡¹ç›®è¯¦æƒ…å¤±è´¥:', error);
            this.showError('åŠ è½½é¡¹ç›®è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    fillEditForm(project) {
        // å¡«å……è¡¨å•å­—æ®µ
        document.getElementById('editProjectName').value = project.name || '';
        document.getElementById('editProjectDescription').value = project.description || '';
        // å°†å°æ—¶è½¬æ¢ä¸ºåˆ†é’Ÿæ˜¾ç¤º
        const estimatedMinutes = Math.round((project.estimated_hours || 0) * 60);
        document.getElementById('editProjectEstimatedHours').value = estimatedMinutes || '';
        document.getElementById('editProjectStatus').value = project.status || 'in_progress';
        
        // æ›´æ–°å­—ç¬¦è®¡æ•°
        this.updateEditDescriptionCharCount(project.description || '');
    }
    
    showEditModal() {
        const modal = document.getElementById('editProjectModal');
        const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-900');
        
        modal.classList.remove('hidden');
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
    }
    
    hideEditModal() {
        const modal = document.getElementById('editProjectModal');
        const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-900');
        
        // æ·»åŠ å…³é—­åŠ¨ç”»
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = '';
        }, 200);
        
        // æ¸…ç†è¡¨å•
        this.clearEditForm();
    }
    
    clearEditForm() {
        document.getElementById('editProjectForm').reset();
        document.getElementById('editProjectMessage').innerHTML = '';
        document.getElementById('editProjectNameError').classList.add('hidden');
        this.updateEditDescriptionCharCount('');
        this.currentEditProjectId = null;
    }
    
    updateEditDescriptionCharCount(text) {
        const countElement = document.getElementById('editProjectDescriptionCount');
        countElement.textContent = `${text.length}/50`;
    }
    
    async saveEditProject(e) {
        e.preventDefault();
        
        const formData = new FormData(document.getElementById('editProjectForm'));
        const projectData = {
            name: formData.get('name'),
            description: formData.get('description'),
            estimated_hours: formData.get('estimated_hours') ? Math.round(parseFloat(formData.get('estimated_hours')) * 100) / 100 / 60 : null, // è½¬æ¢ä¸ºå°æ—¶ï¼Œä¿ç•™2ä½å°æ•°
            status: formData.get('status')
        };
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!projectData.name.trim()) {
            this.showEditError('é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º');
            return;
        }
        
        if (!projectData.estimated_hours || projectData.estimated_hours <= 0) {
            this.showEditError('è¯·é€‰æ‹©æœ‰æ•ˆçš„é¢„ä¼°æ—¶é—´');
            return;
        }
        
        try {
            const url = `/api/projects/${this.currentEditProjectId}`;
            
            // åœ¨demoæ¨¡å¼ä¸‹æ£€æŸ¥æ˜¯å¦è¢«æ‹¦æˆª
            if (window.isDemo && window.interceptDemoModeAPI) {
                if (!window.interceptDemoModeAPI(url, 'PUT')) {
                    return;
                }
            }
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(projectData)
            });
            
            if (response.ok) {
                const data = await response.json();
                this.showEditSuccess('é¡¹ç›®æ›´æ–°æˆåŠŸï¼');
                
                // ç«‹å³å…³é—­æ¨¡æ€æ¡†å¹¶é‡æ–°åŠ è½½é¡¹ç›®åˆ—è¡¨
                this.hideEditModal();
                this.loadProjects(this.currentPage);
                
                // è§¦å‘å…¨å±€äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–æ¨¡å—åˆ·æ–°é¡¹ç›®åˆ—è¡¨
                const projectUpdateEvent = new CustomEvent('projectListUpdated', {
                    detail: { action: 'updated', projectName: projectData.name }
                });
                window.dispatchEvent(projectUpdateEvent);
                console.log('å·²è§¦å‘é¡¹ç›®åˆ—è¡¨æ›´æ–°äº‹ä»¶');
            } else {
                const errorData = await response.json();
                this.showEditError(errorData.error || 'æ›´æ–°é¡¹ç›®å¤±è´¥');
            }
        } catch (error) {
            console.error('æ›´æ–°é¡¹ç›®å¤±è´¥:', error);
            this.showEditError('æ›´æ–°é¡¹ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    showEditSuccess(message) {
        const messageDiv = document.getElementById('editProjectMessage');
        messageDiv.innerHTML = `
            <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-3">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-600 dark:text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-green-800 dark:text-green-200 text-sm">${message}</span>
                </div>
            </div>
        `;
    }
    
    showEditError(message) {
        const messageDiv = document.getElementById('editProjectMessage');
        messageDiv.innerHTML = `
            <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-3">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-600 dark:text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span class="text-red-800 dark:text-red-200 text-sm">${message}</span>
                </div>
            </div>
        `;
    }
    
    async deleteProject(id) {
        const confirmed = await this.showConfirmDialog(
            'åˆ é™¤é¡¹ç›®',
            'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
            'åˆ é™¤',
            'å–æ¶ˆ'
        );
        
        if (confirmed) {
            this.performDeleteProject(id);
        }
    }
    
    async performDeleteProject(id) {
        try {
            const url = `/api/projects/${id}`;
            
            // åœ¨demoæ¨¡å¼ä¸‹æ£€æŸ¥æ˜¯å¦è¢«æ‹¦æˆª
            if (window.isDemo && window.interceptDemoModeAPI) {
                if (!window.interceptDemoModeAPI(url, 'DELETE')) {
                    return;
                }
            }
            
            const response = await fetch(url, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                this.showSuccess('é¡¹ç›®åˆ é™¤æˆåŠŸï¼');
                // é‡æ–°åŠ è½½é¡¹ç›®åˆ—è¡¨
                this.loadProjects(this.currentPage);
                
                // è§¦å‘å…¨å±€äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–æ¨¡å—åˆ·æ–°é¡¹ç›®åˆ—è¡¨
                const projectUpdateEvent = new CustomEvent('projectListUpdated', {
                    detail: { action: 'deleted' }
                });
                window.dispatchEvent(projectUpdateEvent);
                console.log('å·²è§¦å‘é¡¹ç›®åˆ—è¡¨æ›´æ–°äº‹ä»¶');
            } else {
                const errorData = await response.json();
                this.showError(errorData.error || 'åˆ é™¤é¡¹ç›®å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ é™¤é¡¹ç›®å¤±è´¥:', error);
            this.showError('åˆ é™¤é¡¹ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    showError(message) {
        alert(message);
    }

    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    showConfirmDialog(title, message, confirmText = 'ç¡®å®š', cancelText = 'å–æ¶ˆ') {
        return new Promise((resolve) => {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.id = 'confirmModal';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 transform transition-all duration-300">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 mb-4">
                            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">${title}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">${message}</p>
                        <div class="flex space-x-3">
                            <button id="cancelBtn" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300">
                                ${cancelText}
                            </button>
                            <button id="confirmBtn" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors duration-300">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç»‘å®šäº‹ä»¶
            const confirmBtn = modal.querySelector('#confirmBtn');
            const cancelBtn = modal.querySelector('#cancelBtn');

            const cleanup = () => {
                document.body.removeChild(modal);
            };

            confirmBtn.addEventListener('click', () => {
                cleanup();
                resolve(true);
            });

            cancelBtn.addEventListener('click', () => {
                cleanup();
                resolve(false);
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    cleanup();
                    resolve(false);
                }
            });

            // ESCé”®å…³é—­
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    cleanup();
                    resolve(false);
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        });
    }
    
    showSuccess(message) {
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æˆåŠŸæ¶ˆæ¯æç¤º
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full';
        successDiv.innerHTML = `
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(successDiv);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            successDiv.classList.remove('translate-x-full');
        }, 100);
        
        // è‡ªåŠ¨éšè—
        setTimeout(() => {
            successDiv.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 300);
        }, 3000);
    }
    
    cleanupCharts() {
        // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js æœªåŠ è½½ï¼Œè·³è¿‡å›¾è¡¨æ¸…ç†');
            return;
        }
        
        // æ¸…ç†æ‰€æœ‰Chartå®ä¾‹
        Chart.helpers.each(Chart.instances, (instance) => {
            instance.destroy();
        });
        
        // æ¸…ç†æœ¬åœ°å›¾è¡¨å¼•ç”¨
        this.charts = {};
    }

    // è®¡ç®—è¯„çº§
    calculateRating(projectType, minutes) {
        let rating = { level: 'æœªçŸ¥', emoji: 'â“', description: 'æ— æ³•ç¡®å®šè¯„çº§' };
        
        if (projectType === 'math') {
            // æ•°å­¦é¡¹ç›®è¯„çº§æ ‡å‡†
            if (minutes <= 30) {
                rating = { level: 'ä¼˜ç§€', emoji: 'ğŸ˜Š', description: 'å®Œæˆæ—¶é—´â‰¤30åˆ†é’Ÿ' };
            } else if (minutes > 30 && minutes <= 60) {
                rating = { level: 'è‰¯', emoji: 'ğŸ˜Š', description: 'å®Œæˆæ—¶é—´30-60åˆ†é’Ÿ' };
            } else if (minutes > 60 && minutes <= 90) {
                rating = { level: 'ä¸­', emoji: 'ğŸ’ª', description: 'å®Œæˆæ—¶é—´60-90åˆ†é’Ÿ' };
            } else {
                rating = { level: 'å·®', emoji: 'ğŸ˜ ', description: 'å®Œæˆæ—¶é—´>90åˆ†é’Ÿ' };
            }
        } else if (projectType === 'english') {
            // è‹±è¯­é¡¹ç›®è¯„çº§æ ‡å‡†
            if (minutes <= 20) {
                rating = { level: 'ä¼˜ç§€', emoji: 'ğŸ˜Š', description: 'å®Œæˆæ—¶é—´â‰¤20åˆ†é’Ÿ' };
            } else if (minutes > 20 && minutes <= 40) {
                rating = { level: 'è‰¯', emoji: 'ğŸ˜Š', description: 'å®Œæˆæ—¶é—´20-40åˆ†é’Ÿ' };
            } else if (minutes > 40 && minutes <= 60) {
                rating = { level: 'ä¸­', emoji: 'ğŸ’ª', description: 'å®Œæˆæ—¶é—´40-60åˆ†é’Ÿ' };
            } else {
                rating = { level: 'å·®', emoji: 'ğŸ˜ ', description: 'å®Œæˆæ—¶é—´>60åˆ†é’Ÿ' };
            }
        } else if (projectType === 'custom') {
            // è‡ªå®šä¹‰è¯„çº§æ ‡å‡†
            const excellentTime = parseInt(document.getElementById('excellentTime').value) || 30;
            const goodTimeMin = parseInt(document.getElementById('goodTimeMin').value) || 30;
            const goodTimeMax = parseInt(document.getElementById('goodTimeMax').value) || 60;
            const mediumTimeMin = parseInt(document.getElementById('mediumTimeMin').value) || 60;
            const mediumTimeMax = parseInt(document.getElementById('mediumTimeMax').value) || 90;
            const poorTimeMin = parseInt(document.getElementById('poorTimeMin').value) || 90;
            
            if (minutes <= excellentTime) {
                rating = { level: 'ä¼˜ç§€', emoji: 'ğŸ˜Š', description: `å®Œæˆæ—¶é—´â‰¤${excellentTime}åˆ†é’Ÿ` };
            } else if (minutes > goodTimeMin && minutes <= goodTimeMax) {
                rating = { level: 'è‰¯', emoji: 'ğŸ˜Š', description: `å®Œæˆæ—¶é—´${goodTimeMin}-${goodTimeMax}åˆ†é’Ÿ` };
            } else if (minutes > mediumTimeMin && minutes <= mediumTimeMax) {
                rating = { level: 'ä¸­', emoji: 'ğŸ’ª', description: `å®Œæˆæ—¶é—´${mediumTimeMin}-${mediumTimeMax}åˆ†é’Ÿ` };
            } else if (minutes > poorTimeMin) {
                rating = { level: 'å·®', emoji: 'ğŸ˜ ', description: `å®Œæˆæ—¶é—´>${poorTimeMin}åˆ†é’Ÿ` };
            }
        }
        
        return rating;
    }
    
    // è·å–è¯„çº§æ ‡å‡†
    getRatingStandards(projectType) {
        if (projectType === 'math') {
            return {
                excellent: { max: 30, emoji: 'ğŸ˜Š' },
                good: { min: 30, max: 60, emoji: 'ğŸ˜Š' },
                medium: { min: 60, max: 90, emoji: 'ğŸ’ª' },
                poor: { min: 90, emoji: 'ğŸ˜ ' }
            };
        } else if (projectType === 'english') {
            return {
                excellent: { max: 20, emoji: 'ğŸ˜Š' },
                good: { min: 20, max: 40, emoji: 'ğŸ˜Š' },
                medium: { min: 40, max: 60, emoji: 'ğŸ’ª' },
                poor: { min: 60, emoji: 'ğŸ˜ ' }
            };
        } else if (projectType === 'custom') {
            return {
                excellent: { 
                    max: parseInt(document.getElementById('excellentTime').value) || 30, 
                    emoji: 'ğŸ˜Š' 
                },
                good: { 
                    min: parseInt(document.getElementById('goodTimeMin').value) || 30, 
                    max: parseInt(document.getElementById('goodTimeMax').value) || 60, 
                    emoji: 'ğŸ˜Š' 
                },
                medium: { 
                    min: parseInt(document.getElementById('mediumTimeMin').value) || 60, 
                    max: parseInt(document.getElementById('mediumTimeMax').value) || 90, 
                    emoji: 'ğŸ’ª' 
                },
                poor: { 
                    min: parseInt(document.getElementById('poorTimeMin').value) || 90, 
                    emoji: 'ğŸ˜ ' 
                }
            };
        }
        // é»˜è®¤è¯„çº§æ ‡å‡†
        return {
            excellent: { max: 30, emoji: 'ğŸ˜Š' },
            good: { min: 30, max: 60, emoji: 'ğŸ˜Š' },
            medium: { min: 60, max: 90, emoji: 'ğŸ’ª' },
            poor: { min: 90, emoji: 'ğŸ˜ ' }
        };
    }

    // è½¬ä¹‰HTML
    escapeHtml(str) {
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#39;');
    }
}

// åˆå§‹åŒ–å‡½æ•° - ä¾›main-content.hbsè°ƒç”¨
function initializeProjects() {
    console.log('initializeProjects å‡½æ•°è¢«è°ƒç”¨');
    
    // æ¸…ç†ç°æœ‰çš„ ProjectsApp å®ä¾‹
    if (window.projectsApp) {
        console.log('æ¸…ç†ç°æœ‰çš„ ProjectsApp å®ä¾‹');
        // æ¸…ç†æ—§å®ä¾‹çš„å›¾è¡¨
        if (window.projectsApp.charts) {
            Object.values(window.projectsApp.charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
        }
        window.projectsApp = null;
    }
    
    // æ¸…ç†åˆå§‹åŒ–æ ‡è®°ï¼Œå…è®¸é‡æ–°åˆå§‹åŒ–
    window.projectsAppInitialized = false;
    
    // æ£€æŸ¥ProjectsAppç±»æ˜¯å¦å·²å®šä¹‰
    if (typeof ProjectsApp === 'undefined') {
        console.error('ProjectsApp ç±»æœªå®šä¹‰ï¼Œæ— æ³•åˆ›å»ºå®ä¾‹');
        return;
    }
    
    console.log('åˆ›å»ºæ–°çš„ ProjectsApp å®ä¾‹');
    try {
        window.projectsApp = new ProjectsApp();
    } catch (error) {
        console.error('åˆ›å»º ProjectsApp å®ä¾‹å¤±è´¥:', error);
    }
}

// ç¡®ä¿å…¨å±€å‡½æ•°å¯ç”¨
if (typeof window !== 'undefined') {
    window.initializeProjects = initializeProjects;
}

// é¡¹ç›®å®Œæˆç»Ÿè®¡é€»è¾‘
async function loadCompletionStats(projectId, range = 'week') {
  // å¦‚æœæ²¡æœ‰ä¼ å…¥projectIdï¼Œå°è¯•ä»å½“å‰é¡µé¢è·å–
  if (!projectId) {
    // å°è¯•ä»é¡¹ç›®é€‰æ‹©ä¸‹æ‹‰æ¡†è·å–
    const projectSelect = document.getElementById('projectSelect');
    if (projectSelect && projectSelect.value) {
      projectId = projectSelect.value;
    }
    
    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°è¯•ä»URLå‚æ•°è·å–
    if (!projectId) {
      const urlParams = new URLSearchParams(window.location.search);
      projectId = urlParams.get('id');
    }
    
    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°è¯•ä»é¡µé¢å…ƒç´ è·å–
    if (!projectId) {
      const projectIdElement = document.querySelector('[data-project-id]');
      if (projectIdElement) {
        projectId = projectIdElement.getAttribute('data-project-id');
      }
    }
    
    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°è¯•ä»é¡¹ç›®åˆ—è¡¨ä¸­é€‰æ‹©ç¬¬ä¸€ä¸ªé¡¹ç›®
    if (!projectId) {
      const projectRows = document.querySelectorAll('[data-project-id]');
      if (projectRows.length > 0) {
        projectId = projectRows[0].getAttribute('data-project-id');
      }
    }
  }
  
  if (!projectId) {
    console.error('æ— æ³•è·å–é¡¹ç›®ID');
    document.getElementById('completionStatsSummary').textContent = 'æ— æ³•è·å–é¡¹ç›®ID';
    document.getElementById('completionStatsTableBody').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">æ— æ³•è·å–é¡¹ç›®ID</td></tr>';
    return;
  }
  
  const summaryDiv = document.getElementById('completionStatsSummary');
  const tableBody = document.getElementById('completionStatsTableBody');
  const chartCanvas = document.getElementById('completionStatsBarChart');
  summaryDiv.textContent = 'åŠ è½½ä¸­...';
  tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">åŠ è½½ä¸­...</td></tr>';
  if (window.completionStatsChart) {
    window.completionStatsChart.destroy();
  }
  try {
    const res = await fetch(`/api/projects/${projectId}/completion-stats?range=${range}`);
    if (!res.ok) throw new Error('è·å–ç»Ÿè®¡å¤±è´¥');
    const data = await res.json();
    // æ±‡æ€»
    summaryDiv.innerHTML = `
      <span>ç»Ÿè®¡åŒºé—´ï¼š${data.startDate} ~ ${data.endDate}</span> ï½œ
      <span>æ€»å¤©æ•°ï¼š${data.summary.total}</span> ï½œ
      <span>æŒ‰æ—¶å®Œæˆï¼š<span class='text-green-600 font-bold'>${data.summary.onTime}</span></span> ï½œ
      <span>è¶…æ—¶å®Œæˆï¼š<span class='text-red-600 font-bold'>${data.summary.overtime}</span></span> ï½œ
      <span>ä¼˜ç§€ï¼š${data.summary.excellent}ï¼Œè‰¯ï¼š${data.summary.good}ï¼Œä¸­ï¼š${data.summary.medium}ï¼Œå·®ï¼š${data.summary.poor}</span>
    `;
    // è¡¨æ ¼
    tableBody.innerHTML = data.dailyStats.length ? data.dailyStats.map(d => `
      <tr>
        <td class="border px-3 py-1 text-center">${d.date}</td>
        <td class="border px-3 py-1 text-center">${d.duration}</td>
        <td class="border px-3 py-1 text-center">${d.level}</td>
        <td class="border px-3 py-1 text-center">${d.isOnTime ? '<span class=\'text-green-600\'>âœ”</span>' : '<span class=\'text-red-600\'>âœ˜</span>'}</td>
      </tr>
    `).join('') : '<tr><td colspan="4" class="text-center py-4">æš‚æ— æ•°æ®</td></tr>';
    // æç®€æŠ˜çº¿å›¾ - æŒ‰ç…§æ‰‹ç»˜å›¾é£æ ¼
    const labels = data.dailyStats.map(d => d.date);
    const values = data.dailyStats.map(d => d.duration);
    
    // è·å–ä¼˜ç§€åŸºå‡†çº¿æ•°å€¼ï¼ˆæ¯ä¸ªé¡¹ç›®ä¸åŒï¼‰
    let excellentThreshold = 60; // é»˜è®¤å€¼
    if (data.project && data.project.rating_standards) {
      const standards = typeof data.project.rating_standards === 'string' 
        ? JSON.parse(data.project.rating_standards) 
        : data.project.rating_standards;
      
      // å¤„ç†ä¸åŒçš„è¯„çº§æ ‡å‡†ç»“æ„
      if (standards.ä¼˜ç§€) {
        excellentThreshold = standards.ä¼˜ç§€;
      } else if (standards.excellent) {
        // å¤„ç† {"excellent":{"max":60}} ç»“æ„
        if (typeof standards.excellent === 'object' && standards.excellent.max) {
          excellentThreshold = standards.excellent.max;
        } else if (typeof standards.excellent === 'number') {
          excellentThreshold = standards.excellent;
        }
      }
    }
    
    // åˆ›å»ºä¼˜ç§€åŸºå‡†çº¿æ•°æ®ï¼ˆæ°´å¹³çº¿ï¼‰
    const baselineData = labels.map(() => excellentThreshold);
    
    // å‡†å¤‡æŸ±çŠ¶å›¾æ•°æ®
    const chartData = {
      labels: labels,
      datasets: [{
        label: 'å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)',
        data: values,
        backgroundColor: values.map(value => {
          if (value === 0) return 'rgba(156, 163, 175, 0.2)'; // ç°è‰²
          if (value >= excellentThreshold) return 'rgba(34, 197, 94, 0.6)'; // ç»¿è‰²
          if (value >= excellentThreshold * 0.8) return 'rgba(59, 130, 246, 0.6)'; // è“è‰²
          return 'rgba(239, 68, 68, 0.6)'; // çº¢è‰²
        }),
        borderColor: values.map(value => {
          if (value === 0) return 'rgba(156, 163, 175, 0.5)';
          if (value >= excellentThreshold) return 'rgba(34, 197, 94, 0.8)';
          if (value >= excellentThreshold * 0.8) return 'rgba(59, 130, 246, 0.8)';
          return 'rgba(239, 68, 68, 0.8)';
        }),
        borderWidth: 1,
        borderRadius: 4
      }]
    };

    // è®¡ç®—åŠ¨æ€Yè½´æœ€å¤§å€¼
    const maxValue = Math.max(...values, excellentThreshold);
    const yAxisMax = Math.ceil(maxValue / 20) * 20; // å‘ä¸Šå–æ•´åˆ°20çš„å€æ•°

    window.completionStatsChart = new Chart(chartCanvas, {
      type: 'bar',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'å­¦ä¹ æ—¶é•¿ç»Ÿè®¡',
            font: {
              size: 16,
              weight: 'bold'
            }
          },
          legend: {
            display: true,
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + ' åˆ†é’Ÿ';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: yAxisMax,
            ticks: {
              stepSize: 20,
              callback: function(value) {
                return value + ' åˆ†é’Ÿ';
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('åŠ è½½é¡¹ç›®å®Œæˆç»Ÿè®¡å¤±è´¥:', e);
    summaryDiv.textContent = 'åŠ è½½å¤±è´¥';
    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">åŠ è½½å¤±è´¥</td></tr>';
  }
}
// ç›‘å¬æ—¶é—´èŒƒå›´åˆ‡æ¢
if (document.getElementById('statsRangeSelect')) {
  document.getElementById('statsRangeSelect').addEventListener('change', function() {
    // è·å–å½“å‰é€‰ä¸­çš„é¡¹ç›®id
    const projectSelect = document.getElementById('projectSelect');
    const projectId = projectSelect && projectSelect.value ? projectSelect.value : null;
    loadCompletionStats(projectId, this.value);
  });
}

// ç›‘å¬é¡¹ç›®é€‰æ‹©åˆ‡æ¢
if (document.getElementById('projectSelect')) {
  document.getElementById('projectSelect').addEventListener('change', function() {
    // è·å–å½“å‰é€‰ä¸­çš„æ—¶é—´åŒºé—´
    const statsRangeSelect = document.getElementById('statsRangeSelect');
    const range = statsRangeSelect && statsRangeSelect.value ? statsRangeSelect.value : 'week';
    loadCompletionStats(this.value, range);
  });
}
// é¡µé¢åŠ è½½æ—¶ä¸å†è‡ªåŠ¨åŠ è½½ç»Ÿè®¡ï¼Œå› ä¸ºä¼šåœ¨é¡¹ç›®æ•°æ®åŠ è½½å®Œæˆåè‡ªåŠ¨è§¦å‘
// window.addEventListener('DOMContentLoaded', function() {
//   loadCompletionStats(null, document.getElementById('statsRangeSelect')?.value || 'week');
// });




</script> 