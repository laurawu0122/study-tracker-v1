{{!-- æˆå°±é¡µé¢ --}}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800">
  <div class="container mx-auto px-4 py-8">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">
        ğŸ† æˆå°±å¾½ç« 
      </h1>
      <p class="text-gray-600 dark:text-gray-300">
        è®°å½•ä½ çš„å­¦ä¹ é‡Œç¨‹ç¢‘ï¼Œå±•ç¤ºä½ çš„æˆé•¿è½¨è¿¹
      </p>
    </div>

    <!-- æˆå°±ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 text-center">
        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2" id="totalAchievements">0</div>
        <div class="text-gray-600 dark:text-gray-300">æ€»æˆå°±æ•°</div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 text-center">
        <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-2" id="completedAchievements">0</div>
        <div class="text-gray-600 dark:text-gray-300">å·²å®Œæˆ</div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 text-center">
        <div class="text-3xl font-bold text-yellow-600 dark:text-yellow-400 mb-2" id="completionRate">0%</div>
        <div class="text-gray-600 dark:text-gray-300">å®Œæˆç‡</div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 text-center">
        <div class="text-3xl font-bold text-purple-600 dark:text-purple-400 mb-2" id="totalPoints">0</div>
        <div class="text-gray-600 dark:text-gray-300">æ€»ç§¯åˆ†</div>
      </div>
    </div>

    <!-- åˆ†ç±»æ ‡ç­¾ -->
    <div class="mb-8">
      <div id="categoryTabs" class="flex flex-wrap gap-3 justify-center">
        <button class="category-tab active px-6 py-3 rounded-full bg-blue-600 text-white font-medium transition-all duration-300" data-category="all">
          ğŸ† å…¨éƒ¨
        </button>
      </div>
    </div>

    <!-- æˆå°±å±•ç¤ºåŒºåŸŸ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="achievementsGrid">
      <!-- åŠ¨æ€åŠ è½½æˆå°±å¡ç‰‡ -->
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loadingState" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <p class="mt-4 text-gray-600 dark:text-gray-300">åŠ è½½æˆå°±ä¸­...</p>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="emptyState" class="text-center py-12 hidden">
      <div class="text-6xl mb-4">ğŸ†</div>
      <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">è¿˜æ²¡æœ‰è·å¾—æˆå°±</h3>
      <p class="text-gray-600 dark:text-gray-300 mb-6">ç»§ç»­å­¦ä¹ ï¼Œè·å¾—ä½ çš„ç¬¬ä¸€ä¸ªæˆå°±å§ï¼</p>
      <a href="/dashboard" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-300">
        <span>å¼€å§‹å­¦ä¹ </span>
        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>
  </div>
</div>

<!-- æˆå°±è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="achievementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 transform transition-all duration-300">
    <div class="text-center">
      <div id="modalIcon" class="text-6xl mb-4"></div>
      <h3 id="modalTitle" class="text-xl font-bold text-gray-800 dark:text-white mb-2"></h3>
      <p id="modalDescription" class="text-gray-600 dark:text-gray-300 mb-4"></p>
      <div id="modalProgress" class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-1">
          <span>è¿›åº¦</span>
          <span id="progressText">0/0</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
          <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
      <div id="modalPoints" class="text-sm text-gray-600 dark:text-gray-300 mb-4"></div>
      <button onclick="closeAchievementModal()" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300">
        å…³é—­
      </button>
    </div>
  </div>
</div>

<!-- æˆå°±è·å¾—é€šçŸ¥ -->
<div id="achievementNotification" class="fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50 max-w-sm">
  <div class="flex items-center">
    <div class="text-2xl mr-3">ğŸ‰</div>
    <div>
      <div class="font-semibold">æ­å–œè·å¾—æ–°æˆå°±ï¼</div>
      <div id="notificationMessage" class="text-sm opacity-90"></div>
    </div>
  </div>
</div>

<script>
// é˜²æ­¢é‡å¤å£°æ˜
if (typeof window.AchievementPage === 'undefined') {
  window.AchievementPage = class AchievementPage {
    constructor() {
      this.achievements = [];
      this.categories = [];
      this.currentCategory = 'all';
      this.TRIGGER_TYPE_TO_TAB = {
        total_duration: 'å­¦ä¹ æ—¶é•¿',
        session_duration: 'å­¦ä¹ æ—¶é•¿',
        focus_duration: 'å­¦ä¹ æ—¶é•¿',
        total_hours: 'å­¦ä¹ æ—¶é•¿',
        efficiency_rate: 'å­¦ä¹ æ•ˆç‡',
        efficiency_improvement: 'å­¦ä¹ æ•ˆç‡',
        efficiency: 'å­¦ä¹ æ•ˆç‡',
        daily_frequency: 'å­¦ä¹ é¢‘ç‡',
        weekly_frequency: 'å­¦ä¹ é¢‘ç‡',
        monthly_frequency: 'å­¦ä¹ é¢‘ç‡',
        consecutive_days: 'å­¦ä¹ é¢‘ç‡',
        project_completion: 'é¡¹ç›®å®Œæˆ',
        project_rating_streak: 'é¡¹ç›®å®Œæˆ',
        milestone: 'ç‰¹æ®Šæˆå°±',
        innovation: 'ç‰¹æ®Šæˆå°±',
        mastery: 'ç‰¹æ®Šæˆå°±',
        late_night_study: 'ç‰¹æ®Šæˆå°±',
        // å…¶å®ƒç±»å‹å¯ç»§ç»­è¡¥å……
      };
      this.init();
    }

    async init() {
      try {
        console.log('æˆå°±é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
        await this.loadCategories();
        await this.loadAllAchievements();
        await this.loadUserAchievements();
        this.setupEventListeners();
        this.loadStats();
        console.log('æˆå°±é¡µé¢åˆå§‹åŒ–å®Œæˆ');
      } catch (error) {
        console.error('æˆå°±é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
      }
    }

    async loadCategories() {
      try {
        console.log('åŠ è½½æˆå°±åˆ†ç±»...');
        const response = await fetch('/api/achievements/categories', {
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('æˆå°±åˆ†ç±»å“åº”:', result);
        
        if (result.success) {
          this.categories = result.data;
        } else {
          console.error('åŠ è½½æˆå°±åˆ†ç±»å¤±è´¥:', result.error);
        }
      } catch (error) {
        console.error('åŠ è½½æˆå°±åˆ†ç±»å¤±è´¥:', error);
      }
    }

    async loadAllAchievements() {
      try {
        const response = await fetch('/api/achievements/all', {
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.success) {
          this.allAchievements = result.data;
          this.renderCategoryTabs();
        } else {
          this.allAchievements = [];
          this.renderCategoryTabs();
        }
      } catch (error) {
        console.error('åŠ è½½æ‰€æœ‰æˆå°±å®šä¹‰å¤±è´¥:', error);
        this.allAchievements = [];
        this.renderCategoryTabs();
      }
    }

    async loadUserAchievements() {
      try {
        const response = await fetch('/api/achievements/user', {
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.success) {
          this.userAchievements = result.data;
        } else {
          this.userAchievements = [];
        }
        this.mergeAchievements();
        this.renderAchievements();
        this.hideLoading();
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·æˆå°±å¤±è´¥:', error);
        this.userAchievements = [];
        this.mergeAchievements();
        this.renderAchievements();
        this.hideLoading();
      }
    }

    mergeAchievements() {
      // åˆå¹¶æ‰€æœ‰æˆå°±å®šä¹‰å’Œç”¨æˆ·æˆå°±ï¼Œæ ‡è®°is_completed
      // ä¿®å¤ï¼šæ˜¾ç¤ºæ‰€æœ‰æˆå°±ï¼Œä¸ä»…ä»…æ˜¯ç”¨æˆ·å·²è·å¾—çš„
      const userMap = {};
      (this.userAchievements || []).forEach(u => { userMap[u.achievement_id] = u; });
      
      // ç¡®ä¿æ˜¾ç¤ºæ‰€æœ‰æˆå°±å®šä¹‰ï¼ŒåŒ…æ‹¬ç”¨æˆ·æœªè·å¾—çš„
      this.achievements = (this.allAchievements || []).map(a => {
        const userAch = userMap[a.id];
        return {
          ...a,
          is_completed: !!userAch,
          current_progress: userAch ? userAch.current_progress : 0
        };
      });
      
      console.log('åˆå¹¶åçš„æˆå°±æ•°é‡:', this.achievements.length);
      console.log('ç”¨æˆ·æˆå°±æ•°é‡:', this.userAchievements ? this.userAchievements.length : 0);
    }

    renderCategoryTabs() {
      const container = document.getElementById('categoryTabs');
      if (!container) return;
      const allTab = container.querySelector('[data-category="all"]');
      container.innerHTML = '';
      if (allTab) container.appendChild(allTab);
      // ç»Ÿè®¡æ–¹å¼åˆ†ç»„
      const tabMap = {};
      (this.allAchievements || []).forEach(a => {
        const tabName = this.TRIGGER_TYPE_TO_TAB[a.trigger_type] || 'ç‰¹æ®Šæˆå°±';
        if (!tabMap[tabName]) tabMap[tabName] = true;
      });
      Object.keys(tabMap).forEach(tabName => {
        const tab = document.createElement('button');
        tab.className = 'category-tab px-6 py-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium transition-all duration-300 hover:bg-gray-300 dark:hover:bg-gray-600';
        tab.setAttribute('data-category', tabName);
        tab.textContent = tabName;
        container.appendChild(tab);
      });
    }

    renderAchievements() {
      const container = document.getElementById('achievementsGrid');
      if (!container) return;
      container.innerHTML = '';
      let filteredAchievements = this.currentCategory === 'all'
        ? this.achievements
        : this.achievements.filter(a => {
            const tabName = this.TRIGGER_TYPE_TO_TAB[a.trigger_type] || 'ç‰¹æ®Šæˆå°±';
            return tabName === this.currentCategory;
          });
      // ç”¨åç§°+æè¿°+å›¾æ ‡ä¸‰å…ƒç»„å»é‡
      const seenKeys = new Set();
      filteredAchievements = filteredAchievements.filter(a => {
        const key = `${a.achievement_name}||${a.achievement_description}||${a.achievement_icon}`;
        if (seenKeys.has(key)) return false;
        seenKeys.add(key);
        return true;
      });
      if (filteredAchievements.length === 0) {
        this.showEmptyState();
        return;
      }
      filteredAchievements.forEach(achievement => {
        const card = this.createAchievementCard(achievement);
        container.appendChild(card);
      });
    }

    createAchievementCard(achievement) {
      const card = document.createElement('div');
      // å·²å®Œæˆé«˜äº®ï¼Œæœªå®Œæˆç°è‰²
      const isCompleted = achievement.is_completed;
      card.className = 'achievement-card bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 text-center transform hover:scale-105 transition-all duration-300 cursor-pointer ' +
        (isCompleted ? 'badge-animate-pop badge-glow' : 'opacity-50 grayscale');
      card.setAttribute('data-achievement-id', achievement.id);

      const progress = achievement.current_progress || 0;
      // ä» criteria_config ä¸­è·å–ç›®æ ‡å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º1
      let targetValue = 1;
      try {
        if (achievement.criteria_config && achievement.criteria_config !== 'undefined' && achievement.criteria_config !== 'null') {
          const conditions = typeof achievement.criteria_config === 'string' 
            ? JSON.parse(achievement.criteria_config) 
            : achievement.criteria_config;
          
          switch (achievement.trigger_type) {
            case 'total_duration':
              targetValue = conditions.target_minutes || 600;
              break;
            case 'consecutive_days':
              targetValue = conditions.target_days || 7;
              break;
            case 'project_completion':
              targetValue = conditions.target_count || 1;
              break;
            default:
              targetValue = 1;
          }
        }
      } catch (e) {
        console.error('è§£ææˆå°±é…ç½®å¤±è´¥:', e);
        targetValue = 1;
      }
      
      const progressPercent = isCompleted ? 100 : Math.min((progress / targetValue) * 100, 100);

      // å›¾æ ‡classï¼šå·²å®ŒæˆåŠ åŠ¨ç”»å’Œé«˜å…‰ï¼Œæœªå®ŒæˆåŠ æ·¡å…¥
      let iconHtml = '';
      if (achievement.achievement_icon && achievement.achievement_icon.endsWith('.svg')) {
        iconHtml = `<img src="${achievement.achievement_icon}" alt="å¾½ç« " class="mx-auto h-16 w-16 mb-4 badge-glow bg-transparent" />`;
      } else {
        iconHtml = `<i class="${achievement.achievement_icon} text-6xl mb-4 ${isCompleted ? 'badge-animate-pop badge-glow' : 'badge-fade-in opacity-50'}"></i>`;
      }

      card.innerHTML = `
        ${iconHtml}
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">${achievement.achievement_name}</h3>
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">${achievement.achievement_description}</p>
        <div class="progress-container mb-4">
          <div class="flex justify-between text-xs text-gray-600 dark:text-gray-300 mb-1">
            <span>è¿›åº¦</span>
            <span>${progress}/${targetValue}</span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div class="progress-bar bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
          </div>
        </div>
        <div class="flex justify-between items-center text-sm">
          <span class="text-gray-600 dark:text-gray-300">${achievement.category_name}</span>
          <span class="text-yellow-600 dark:text-yellow-400 font-semibold">+${achievement.points} ç§¯åˆ†</span>
        </div>
        ${isCompleted ? '<div class="mt-2 text-xs text-green-600 dark:text-green-400">âœ“ å·²å®Œæˆ</div>' : ''}
      `;

      card.addEventListener('click', () => this.showAchievementModal(achievement));
      return card;
    }

    showAchievementModal(achievement) {
      const modal = document.getElementById('achievementModal');
      const icon = document.getElementById('modalIcon');
      const title = document.getElementById('modalTitle');
      const description = document.getElementById('modalDescription');
      const progressText = document.getElementById('progressText');
      const progressBar = document.getElementById('progressBar');
      const points = document.getElementById('modalPoints');

      // ä¿®å¤ï¼šå¼¹çª—iconæ”¯æŒSVGå’Œicon class
      if (achievement.achievement_icon && achievement.achievement_icon.endsWith('.svg')) {
        icon.innerHTML = `<img src="${achievement.achievement_icon}" alt="å¾½ç« " class="mx-auto h-20 w-20 mb-2 badge-glow" />`;
      } else {
        icon.innerHTML = `<i class="${achievement.achievement_icon} text-6xl badge-glow"></i>`;
      }
      
      title.textContent = achievement.achievement_name;
      description.textContent = achievement.achievement_description;
      
      const progress = achievement.current_progress || 0;
      // ä» criteria_config ä¸­è·å–ç›®æ ‡å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º1
      let targetValue = 1;
      try {
        if (achievement.criteria_config && achievement.criteria_config !== 'undefined' && achievement.criteria_config !== 'null') {
          const conditions = typeof achievement.criteria_config === 'string' 
            ? JSON.parse(achievement.criteria_config) 
            : achievement.criteria_config;
          
          switch (achievement.trigger_type) {
            case 'total_duration':
              targetValue = conditions.target_minutes || 600;
              break;
            case 'consecutive_days':
              targetValue = conditions.target_days || 7;
              break;
            case 'project_completion':
              targetValue = conditions.target_count || 1;
              break;
            default:
              targetValue = 1;
          }
        }
      } catch (e) {
        console.error('è§£ææˆå°±é…ç½®å¤±è´¥:', e);
        targetValue = 1;
      }
      
      const progressPercent = achievement.is_completed ? 100 : Math.min((progress / targetValue) * 100, 100);
      
      progressText.textContent = `${progress}/${targetValue}`;
      progressBar.style.width = `${progressPercent}%`;
      points.textContent = `è·å¾—ç§¯åˆ†: ${achievement.points}`;

      modal.classList.remove('hidden');
    }

    updateStats(stats) {
      const totalEl = document.getElementById('totalAchievements');
      const completedEl = document.getElementById('completedAchievements');
      const rateEl = document.getElementById('completionRate');
      const pointsEl = document.getElementById('totalPoints');
      
      if (totalEl) totalEl.textContent = stats.total_achievements || 0;
      if (completedEl) completedEl.textContent = stats.completed_achievements || 0;
      if (rateEl) rateEl.textContent = `${stats.completion_rate || 0}%`;
      if (pointsEl) pointsEl.textContent = stats.total_points || 0;
    }

    setupEventListeners() {
      const container = document.getElementById('categoryTabs');
      if (!container) {
        console.error('æ‰¾ä¸åˆ°åˆ†ç±»æ ‡ç­¾å®¹å™¨');
        return;
      }
      // åˆ†ç±»æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
      container.addEventListener('click', (e) => {
        if (e.target.classList.contains('category-tab')) {
          // æ›´æ–°æ´»åŠ¨çŠ¶æ€
          document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active', 'bg-blue-600', 'text-white');
            tab.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
          });
          e.target.classList.add('active', 'bg-blue-600', 'text-white');
          e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
          // æ›´æ–°å½“å‰åˆ†ç±»
          this.currentCategory = e.target.getAttribute('data-category'); // ç°åœ¨æ˜¯ name
          this.renderAchievements();
        }
      });
    }

    hideLoading() {
      const loadingEl = document.getElementById('loadingState');
      if (loadingEl) {
        loadingEl.classList.add('hidden');
      }
    }

    showEmptyState() {
      const emptyEl = document.getElementById('emptyState');
      if (emptyEl) {
        emptyEl.classList.remove('hidden');
      }
    }

    showNotification(message) {
      const notification = document.getElementById('achievementNotification');
      const messageEl = document.getElementById('notificationMessage');
      
      if (notification && messageEl) {
        messageEl.textContent = message;
        notification.classList.remove('translate-x-full');
        
        setTimeout(() => {
          notification.classList.add('translate-x-full');
        }, 3000);
      }
    }

    loadStats() {
      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      const totalAchievements = this.achievements.length;
      const completedAchievements = this.achievements.filter(a => a.is_completed).length;
      const completionRate = totalAchievements > 0 ? Math.round((completedAchievements / totalAchievements) * 100) : 0;
      const totalPoints = this.achievements
        .filter(a => a.is_completed)
        .reduce((sum, a) => sum + (a.points || 0), 0);

      // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
      this.updateStats({
        total_achievements: totalAchievements,
        completed_achievements: completedAchievements,
        completion_rate: completionRate,
        total_points: totalPoints
      });
    }
  }
}

// å…¨å±€å‡½æ•°
function closeAchievementModal() {
  const modal = document.getElementById('achievementModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æˆå°±é¡µé¢');
    new window.AchievementPage();
  });
} else {
  console.log('DOMå·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–æˆå°±é¡µé¢');
  new window.AchievementPage();
}
</script> 