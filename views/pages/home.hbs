<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ é¡¹ç›®è¿½è¸ªç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/assets/css/tailwind.css">
    <script src="/assets/js/htmx.min.js"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-gray-900">ğŸ“š å­¦ä¹ è¿½è¸ªç³»ç»Ÿ</span>
                </div>
                <div class="flex space-x-4">
                    <button id="loginBtn" class="text-gray-700 hover:text-blue-600 px-3 py-2">ç™»å½•</button>
                    <button id="registerBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-12">
        <div class="text-center mb-16">
            <h1 class="text-4xl font-bold text-gray-900 mb-6">ç°ä»£åŒ–å­¦ä¹ ç®¡ç†å¹³å°</h1>
            <p class="text-xl text-gray-600 mb-8">è®°å½•å­¦ä¹ é¡¹ç›®å®Œæˆæ—¶é—´ï¼Œåˆ†æå­¦ä¹ æ•ˆç‡è¶‹åŠ¿</p>
            <div class="flex justify-center space-x-4">
                <button id="startBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg">å¼€å§‹ä½¿ç”¨</button>
                <button id="demoBtn" class="border border-gray-300 text-gray-700 hover:bg-gray-50 px-8 py-3 rounded-lg">æŸ¥çœ‹æ¼”ç¤º</button>
            </div>
        </div>

        <div class="grid md:grid-cols-3 gap-8 mb-16">
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="text-2xl mb-4">ğŸ“Š</div>
                <h3 class="text-xl font-semibold mb-2">æ•°æ®å¯è§†åŒ–</h3>
                <p class="text-gray-600">å¤šç§å›¾è¡¨å±•ç¤ºå­¦ä¹ è¶‹åŠ¿å’Œç»Ÿè®¡</p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="text-2xl mb-4">â±ï¸</div>
                <h3 class="text-xl font-semibold mb-2">æ—¶é—´è¿½è¸ª</h3>
                <p class="text-gray-600">ç²¾ç¡®è®°å½•å­¦ä¹ æ—¶é—´ï¼Œå®æ—¶ç»Ÿè®¡</p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="text-2xl mb-4">ğŸ“±</div>
                <h3 class="text-xl font-semibold mb-2">å“åº”å¼è®¾è®¡</h3>
                <p class="text-gray-600">å®Œç¾é€‚é…æ¡Œé¢å’Œç§»åŠ¨å¹³æ¿è®¾å¤‡</p>
            </div>
        </div>
    </div>

    <!-- ç‰ˆæƒä¿¡æ¯ -->
    <footer class="bg-white border-t border-gray-200 py-8 mt-16">
        <div class="max-w-7xl mx-auto px-4">
            <div class="text-center">
                <p class="text-gray-600 text-sm">
                    Â© 2025 <a href="http://www.richarvin.com" target="_blank" class="text-black font-bold no-underline">çŸ¥è¡Œç¬”è®°</a>. All rights reserved.
                </p>
            </div>
        </div>
    </footer>

    <!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 class="text-xl font-semibold text-gray-900">ç™»å½•</h2>
                    <button id="closeLoginModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form hx-post="/api/auth/login" hx-target="#loginMessage" hx-swap="innerHTML" class="p-6">
                    <div class="mb-4">
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" name="username" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               autocomplete="username">
                    </div>
                    <div class="mb-6">
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                        <div class="relative">
                            <input type="password" id="loginPassword" name="password" required 
                                   class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   autocomplete="current-password">
                            <button type="button" id="loginPasswordToggle" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="loginPasswordEye">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="loginMessage"></div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition duration-200">
                        ç™»å½•
                    </button>
                    <div class="mt-4 text-center">
                        <button type="button" id="forgotPasswordBtn" class="text-blue-600 hover:text-blue-800 text-sm">
                            å¿˜è®°å¯†ç ï¼Ÿ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œå¼¹çª— -->
    {{> register-modal}}

    <!-- å¿˜è®°å¯†ç å¼¹çª— -->
    <div id="forgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 class="text-xl font-semibold text-gray-900">é‡ç½®å¯†ç </h2>
                    <button id="closeForgotPasswordModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="forgotPasswordForm" class="p-6">
                    <div class="mb-4">
                        <label for="forgotPasswordEmail" class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±åœ°å€</label>
                        <input type="email" id="forgotPasswordEmail" name="email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="è¯·è¾“å…¥æ‚¨çš„æ³¨å†Œé‚®ç®±">
                    </div>
                    <div class="mb-4">
                        <label for="resetVerificationCode" class="block text-sm font-medium text-gray-700 mb-2">éªŒè¯ç </label>
                        <div class="flex space-x-2">
                            <input type="text" id="resetVerificationCode" name="verificationCode" required 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6" pattern="[0-9]{6}">
                            <button type="button" id="sendResetCodeBtn" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 whitespace-nowrap">
                                å‘é€éªŒè¯ç 
                            </button>
                        </div>
                    </div>
                                        <div class="mb-4">
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">æ–°å¯†ç </label>
                        <div class="relative">
                            <input type="password" id="newPassword" name="newPassword" required 
                                   class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰" autocomplete="new-password">
                            <button type="button" id="newPasswordToggle" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="newPasswordEye">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">å¯†ç é•¿åº¦è‡³å°‘ä¸º8ä½</p>
                    </div>
                    <div class="mb-6">
                        <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-2">ç¡®è®¤æ–°å¯†ç </label>
                        <div class="relative">
                                                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" required 
                               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " autocomplete="new-password">
                            <button type="button" id="confirmNewPasswordToggle" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="confirmNewPasswordEye">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="forgotPasswordMessage" class="text-base text-center mb-4"></div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200">
                        é‡ç½®å¯†ç 
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- å…¨å±€é€šçŸ¥ç³»ç»Ÿ -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2" style="display: none;">
        <!-- é€šçŸ¥ä¼šåŠ¨æ€æ’å…¥è¿™é‡Œ -->
    </div>

    <script src="/assets/js/main.js"></script>
    <script>
    // å¼¹çª—æ§åˆ¶
    function showModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // é‡æ–°åˆå§‹åŒ–å¯†ç åˆ‡æ¢åŠŸèƒ½
        setTimeout(initPasswordToggles, 100);
    }

    function hideModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // ç™»å½•å¼¹çª—
    document.getElementById('loginBtn').addEventListener('click', () => {
        showModal('loginModal');
    });

    document.getElementById('closeLoginModal').addEventListener('click', () => {
        hideModal('loginModal');
    });

    // æ³¨å†Œå¼¹çª—
    document.getElementById('registerBtn').addEventListener('click', () => {
        showModal('registerModal');
    });

    document.getElementById('closeRegisterModal').addEventListener('click', () => {
        hideModal('registerModal');
    });

    // å¼€å§‹ä½¿ç”¨æŒ‰é’®
    document.getElementById('startBtn').addEventListener('click', () => {
        showModal('loginModal');
    });

    // æ¼”ç¤ºæŒ‰é’®
    document.getElementById('demoBtn').addEventListener('click', () => {
        window.location.href = '/demo';
    });

    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
    document.getElementById('loginModal').addEventListener('click', (e) => {
        if (e.target.id === 'loginModal') {
            hideModal('loginModal');
        }
    });

    document.getElementById('registerModal').addEventListener('click', (e) => {
        if (e.target.id === 'registerModal') {
            hideModal('registerModal');
        }
    });

    // HTMX æˆåŠŸç™»å½•åè·³è½¬
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.xhr.responseURL && evt.detail.xhr.responseURL.includes('/auth/login')) {
            if (evt.detail.xhr.status === 200) {
                // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ä»ªè¡¨æ¿
                window.location.href = '/dashboard';
            }
        }
        if (evt.detail.xhr.responseURL && evt.detail.xhr.responseURL.includes('/auth/register')) {
            if (evt.detail.xhr.status === 201) {
                // æ³¨å†ŒæˆåŠŸï¼Œå…³é—­æ³¨å†Œå¼¹çª—ï¼Œæ˜¾ç¤ºç™»å½•å¼¹çª—
                hideModal('registerModal');
                showModal('loginModal');
            }
        }
    });

    // HTMX é”™è¯¯å¤„ç†
    document.body.addEventListener('htmx:responseError', function(evt) {
        const target = evt.target;
        const messageTarget = target.querySelector('[id$="Message"]') || target.querySelector('#loginMessage') || target.querySelector('#registerMessage');
        
        if (messageTarget) {
            let errorMessage = 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            
            // å°è¯•ä»å“åº”ä¸­è·å–å…·ä½“çš„é”™è¯¯ä¿¡æ¯
            try {
                const response = evt.detail.xhr;
                if (response && response.responseText) {
                    const responseData = JSON.parse(response.responseText);
                    if (responseData.error) {
                        errorMessage = responseData.error;
                    }
                }
            } catch (e) {
                // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ä¿¡æ¯
                console.log('æ— æ³•è§£æé”™è¯¯å“åº”:', e);
            }
            
            messageTarget.innerHTML = `<div class="text-red-700 dark:text-red-400 text-sm">${errorMessage}</div>`;
        }
    });

    // å¯†ç æ˜¾ç¤º/éšè—åŠŸèƒ½
    function initPasswordToggles() {
        // ç™»å½•å¯†ç åˆ‡æ¢
        const loginPasswordToggle = document.getElementById('loginPasswordToggle');
        const loginPassword = document.getElementById('loginPassword');
        const loginPasswordEye = document.getElementById('loginPasswordEye');
        
        if (loginPasswordToggle && loginPassword && !loginPasswordToggle.dataset.bound) {
            loginPasswordToggle.dataset.bound = 'true';
            loginPasswordToggle.addEventListener('click', function() {
                const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                loginPassword.setAttribute('type', type);
                
                // åˆ‡æ¢å›¾æ ‡
                if (type === 'text') {
                    loginPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                    `;
                } else {
                    loginPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            });
        }

        // æ³¨å†Œå¯†ç åˆ‡æ¢
        const registerPasswordToggle = document.getElementById('registerPasswordToggle');
        const registerPassword = document.getElementById('registerPassword');
        const registerPasswordEye = document.getElementById('registerPasswordEye');
        
        if (registerPasswordToggle && registerPassword && !registerPasswordToggle.dataset.bound) {
            registerPasswordToggle.dataset.bound = 'true';
            registerPasswordToggle.addEventListener('click', function() {
                const type = registerPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                registerPassword.setAttribute('type', type);
                
                // åˆ‡æ¢å›¾æ ‡
                if (type === 'text') {
                    registerPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                    `;
                } else {
                    registerPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            });
        }

        // ç¡®è®¤å¯†ç åˆ‡æ¢
        const registerConfirmPasswordToggle = document.getElementById('registerConfirmPasswordToggle');
        const registerConfirmPassword = document.getElementById('registerConfirmPassword');
        const registerConfirmPasswordEye = document.getElementById('registerConfirmPasswordEye');
        
        if (registerConfirmPasswordToggle && registerConfirmPassword && !registerConfirmPasswordToggle.dataset.bound) {
            registerConfirmPasswordToggle.dataset.bound = 'true';
            registerConfirmPasswordToggle.addEventListener('click', function() {
                const type = registerConfirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                registerConfirmPassword.setAttribute('type', type);
                
                // åˆ‡æ¢å›¾æ ‡
                if (type === 'text') {
                    registerConfirmPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                    `;
                } else {
                    registerConfirmPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            });
        }

        // å¿˜è®°å¯†ç å¼¹çª—ä¸­çš„å¯†ç åˆ‡æ¢
        const newPasswordToggle = document.getElementById('newPasswordToggle');
        const newPassword = document.getElementById('newPassword');
        const newPasswordEye = document.getElementById('newPasswordEye');
        
        if (newPasswordToggle && newPassword && !newPasswordToggle.dataset.bound) {
            newPasswordToggle.dataset.bound = 'true';
            newPasswordToggle.addEventListener('click', function() {
                const type = newPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                newPassword.setAttribute('type', type);
                
                // åˆ‡æ¢å›¾æ ‡
                if (type === 'text') {
                    newPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                    `;
                } else {
                    newPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            });
        }

        const confirmNewPasswordToggle = document.getElementById('confirmNewPasswordToggle');
        const confirmNewPassword = document.getElementById('confirmNewPassword');
        const confirmNewPasswordEye = document.getElementById('confirmNewPasswordEye');
        
        if (confirmNewPasswordToggle && confirmNewPassword && !confirmNewPasswordToggle.dataset.bound) {
            confirmNewPasswordToggle.dataset.bound = 'true';
            confirmNewPasswordToggle.addEventListener('click', function() {
                const type = confirmNewPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                confirmNewPassword.setAttribute('type', type);
                
                // åˆ‡æ¢å›¾æ ‡
                if (type === 'text') {
                    confirmNewPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                    `;
                } else {
                    confirmNewPasswordEye.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            });
        }
    }

    // å¿˜è®°å¯†ç å¼¹çª—æ§åˆ¶
    document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
        hideModal('loginModal');
        showModal('forgotPasswordModal');
    });

    document.getElementById('closeForgotPasswordModal').addEventListener('click', () => {
        hideModal('forgotPasswordModal');
    });

    document.getElementById('forgotPasswordModal').addEventListener('click', (e) => {
        if (e.target.id === 'forgotPasswordModal') {
            hideModal('forgotPasswordModal');
        }
    });

    // å‘é€é‡ç½®éªŒè¯ç 
    document.getElementById('sendResetCodeBtn').addEventListener('click', async function() {
        const email = document.getElementById('forgotPasswordEmail').value;
        if (!email) {
            document.getElementById('forgotPasswordMessage').innerHTML = 
                '<div class="text-red-700 dark:text-red-400 text-sm">è¯·å…ˆè¾“å…¥é‚®ç®±åœ°å€</div>';
            return;
        }

        this.disabled = true;
        this.textContent = 'å‘é€ä¸­...';

        try {
            const response = await fetch('/api/auth/send-reset-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email })
            });

            const data = await response.json();
            
            if (response.ok) {
                document.getElementById('forgotPasswordMessage').innerHTML = 
                    '<div class="p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm">éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±</div>';
                
                // å€’è®¡æ—¶60ç§’
                let countdown = 60;
                const timer = setInterval(() => {
                    this.textContent = `${countdown}ç§’åé‡è¯•`;
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(timer);
                        this.disabled = false;
                        this.textContent = 'å‘é€éªŒè¯ç ';
                    }
                }, 1000);
            } else {
                document.getElementById('forgotPasswordMessage').innerHTML = 
                    `<div class="text-red-700 dark:text-red-400 text-sm">${data.error || 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'}</div>`;
                this.disabled = false;
                this.textContent = 'å‘é€éªŒè¯ç ';
            }
        } catch (error) {
            document.getElementById('forgotPasswordMessage').innerHTML = 
                '<div class="text-red-700 dark:text-red-400 text-sm">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>';
            this.disabled = false;
            this.textContent = 'å‘é€éªŒè¯ç ';
        }
    });

    // å¿˜è®°å¯†ç è¡¨å•æäº¤
    document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('forgotPasswordEmail').value;
        const verificationCode = document.getElementById('resetVerificationCode').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        // å‰ç«¯éªŒè¯
        if (!email || !verificationCode || !newPassword || !confirmNewPassword) {
            document.getElementById('forgotPasswordMessage').innerHTML = 
                '<div class="text-red-700 dark:text-red-400 text-sm">è¯·å®Œæ•´å¡«å†™æ‰€æœ‰ä¿¡æ¯</div>';
            return;
        }
        
        if (newPassword.length < 8) {
            document.getElementById('forgotPasswordMessage').innerHTML = 
                '<div class="text-red-700 dark:text-red-400 text-sm">å¯†ç é•¿åº¦è‡³å°‘ä¸º8ä½</div>';
            return;
        }
        
        // éªŒè¯å¯†ç ä¸€è‡´æ€§
        if (newPassword !== confirmNewPassword) {
            document.getElementById('forgotPasswordMessage').innerHTML = 
                '<div class="text-red-700 dark:text-red-400 text-sm">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>';
            return;
        }

        try {
            console.log('ğŸ” æäº¤é‡ç½®å¯†ç è¯·æ±‚:', { email, verificationCode, newPassword: newPassword ? '***' : 'empty' });
            
            const response = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email,
                    verificationCode,
                    newPassword
                })
            });

            const data = await response.json();
            console.log('ğŸ” é‡ç½®å¯†ç å“åº”:', { status: response.status, data });
            
            if (response.ok) {
                document.getElementById('forgotPasswordMessage').innerHTML = 
                    '<div class="p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm">å¯†ç é‡ç½®æˆåŠŸï¼è¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•</div>';
                
                // 3ç§’åå…³é—­å¼¹çª—å¹¶æ˜¾ç¤ºç™»å½•å¼¹çª—
                setTimeout(() => {
                    hideModal('forgotPasswordModal');
                    showModal('loginModal');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('forgotPasswordForm').reset();
                    document.getElementById('forgotPasswordMessage').innerHTML = '';
                }, 3000);
            } else {
                const errorMessage = data.error || data.details?.map(d => d.msg).join(', ') || 'é‡ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                document.getElementById('forgotPasswordMessage').innerHTML = 
                    `<div class="text-red-700 dark:text-red-400 text-sm">${errorMessage}</div>`;
            }
        } catch (error) {
            document.getElementById('forgotPasswordMessage').innerHTML = 
                '<div class="text-red-700 dark:text-red-400 text-sm">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div>';
        }
    });

    // æ³¨å†Œå¯†ç ä¸€è‡´æ€§éªŒè¯
    function checkPasswordMatch() {
        const password = document.getElementById('registerPassword');
        const confirmPassword = document.getElementById('registerConfirmPassword');
        const messageElement = document.getElementById('passwordMatchMessage');
        
        if (password && confirmPassword && messageElement) {
            const checkMatch = () => {
                if (confirmPassword.value === '') {
                    messageElement.innerHTML = '';
                } else if (password.value === confirmPassword.value) {
                    messageElement.innerHTML = '<div class="text-green-600 text-sm">âœ“ å¯†ç åŒ¹é…</div>';
                } else {
                    messageElement.innerHTML = '<div class="text-red-600 text-sm">âœ— å¯†ç ä¸åŒ¹é…</div>';
                }
            };
            
            password.addEventListener('input', checkMatch);
            confirmPassword.addEventListener('input', checkMatch);
        }
    }

    // åˆå§‹åŒ–å¯†ç åˆ‡æ¢åŠŸèƒ½
    function initHomePage() {
        // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        if (window.homePageInitialized) {
            return;
        }
        window.homePageInitialized = true;
        
        initPasswordToggles();
        checkPasswordMatch();
    }
    
    // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHomePage);
    } else {
        initHomePage();
    }
    

    </script>
</body>
</html> 