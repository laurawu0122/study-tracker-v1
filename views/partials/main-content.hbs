<!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
<div class="flex flex-col min-h-0">
    <!-- Mobile Header -->
    <div class="lg:hidden bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between h-16 px-4">
            <button id="mobileMenuButton" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <span>â˜°</span>
            </button>
            <h1 class="text-lg font-semibold text-gray-900 dark:text-white">ğŸ“š å­¦ä¹ è¿½è¸ª</h1>
            <div class="flex items-center space-x-2">
                <button id="mobileDarkModeToggle" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <span id="mobileDarkModeIcon">ğŸŒ™</span>
                </button>
                <div class="w-8 h-8 bg-gray-800 dark:bg-gray-700 rounded-full flex items-center justify-center text-white font-medium border-2 border-gray-300 dark:border-gray-600 overflow-hidden header-avatar">
                    {{#if user.avatar}}
                        <img src="/uploads/avatars/{{user.avatar}}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full object-cover">
                    {{else}}
                        {{user.username.[0]}}
                    {{/if}}
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Header -->
    <div class="hidden lg:flex items-center justify-between h-16 px-6 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center space-x-4">
            <h1 id="pageTitle" class="text-xl font-semibold text-gray-900 dark:text-white">æ¬¢è¿ä½¿ç”¨å­¦ä¹ è¿½è¸ªç³»ç»Ÿ</h1>
            {{#if breadcrumbs}}
            <nav class="flex space-x-2 text-sm text-gray-500 dark:text-gray-400">
                {{#each breadcrumbs}}
                <span>{{this}}</span>
                {{#unless @last}}<span>/</span>{{/unless}}
                {{/each}}
            </nav>
            {{/if}}
        </div>
        <div class="flex items-center space-x-4">
            <button id="desktopDarkModeToggle" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                <span id="desktopDarkModeIcon">ğŸŒ™</span>
            </button>
            <div class="relative" id="userDropdown">
                <button id="userDropdownButton" class="flex items-center space-x-2 p-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <div class="w-8 h-8 bg-gray-800 dark:bg-gray-700 rounded-full flex items-center justify-center text-white font-medium border-2 border-gray-300 dark:border-gray-600 overflow-hidden header-avatar">
                        {{#if user.avatar}}
                            <img src="/uploads/avatars/{{user.avatar}}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full object-cover">
                        {{else}}
                            {{user.username.[0]}}
                        {{/if}}
                    </div>
                    <span class="hidden md:block">{{user.username}}</span>
                </button>
                <div id="userDropdownMenu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                    <div class="py-2">
                        <button id="openProfileModalBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            ä¸ªäººè®¾ç½®
                        </button>
                        <a href="/logout" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            é€€å‡ºç™»å½•
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 bg-gray-50 dark:bg-gray-900 min-h-0">
        <div id="contentArea" class="p-6">
            <!-- åŠ¨æ€å†…å®¹åŒºåŸŸ -->
            <div id="dynamicContent">
                <!-- åŠ¨æ€å†…å®¹å°†é€šè¿‡AJAXåŠ è½½ -->
            </div>
        </div>
    </main>
</div>

<!-- ä¸ªäººè®¾ç½®å¼¹çª— -->
<div id="profileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm transition-all duration-300 hidden p-4">
    <div class="relative w-full mx-2 sm:mx-auto" style="max-width: 32rem; width: 100%; max-height: 90vh;">
        <!-- å¼¹çª—ä¸»ä½“ -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl transition-all duration-300 scale-95 opacity-0 flex flex-col" style="width: 100%; max-height: 90vh;">
            <!-- å¤´éƒ¨ -->
            <div class="flex items-center justify-between px-6 pt-6 pb-2 border-b border-gray-100 dark:border-gray-800 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">ä¸ªäººè®¾ç½®</h3>
                </div>
                <button id="closeProfileModalBtn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                    <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å†…å®¹åŒº -->
            <form id="profileForm" class="px-6 py-6 flex-1 overflow-y-auto">
                <div class="space-y-4">
                    <!-- ç”¨æˆ·å¤´åƒ -->
                    <div class="flex items-center justify-center mb-6">
                        <div class="relative">
                            <!-- å¤´åƒæ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="avatarDisplay" class="w-20 h-20 bg-gray-800 dark:bg-gray-700 rounded-full flex items-center justify-center text-white text-2xl font-bold border-4 border-gray-300 dark:border-gray-600 overflow-hidden">
                                {{#if user.avatar}}
                                    <img id="avatarImage" src="/uploads/avatars/{{user.avatar}}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full object-cover">
                                {{else}}
                                    <span id="avatarInitial">{{user.username.[0]}}</span>
                                {{/if}}
                            </div>
                            
                            <!-- å¤´åƒä¸Šä¼ æŒ‰é’® -->
                            <button type="button" id="changeAvatarBtn" class="absolute -bottom-1 -right-1 w-7 h-7 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs hover:bg-blue-700 transition-colors shadow-lg">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                            
                            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                            <input type="file" id="avatarInput" accept="image/*" class="hidden">
                        </div>
                    </div>
                    
                    <!-- å¤´åƒæ“ä½œæç¤º -->
                    <div class="text-center mb-4">
                        <p class="text-xs text-gray-500 dark:text-gray-400">ç‚¹å‡»ç›¸æœºå›¾æ ‡ä¸Šä¼ å¤´åƒï¼Œæ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
                    </div>

                    <!-- ç”¨æˆ·å -->
                    <div>
                        <label for="profileUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            ç”¨æˆ·å <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="profileUsername" name="username" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                               placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="{{user.username}}" autocomplete="username">
                    </div>

                    <!-- é‚®ç®±åœ°å€ -->
                    <div>
                        <label for="profileEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            é‚®ç®±åœ°å€ <span class="text-red-500">*</span>
                        </label>
                        <input type="email" id="profileEmail" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                               placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" value="{{user.email}}" autocomplete="email">
                    </div>

                    <!-- å½“å‰å¯†ç  -->
                    <div>
                        <label for="currentPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            å½“å‰å¯†ç 
                        </label>
                        <input type="password" id="currentPassword" name="currentPassword" autocomplete="current-password"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                               placeholder="å¦‚éœ€ä¿®æ”¹å¯†ç è¯·è¾“å…¥å½“å‰å¯†ç ">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">åªæœ‰è¾“å…¥å½“å‰å¯†ç æ‰èƒ½ä¿®æ”¹å¯†ç </p>
                    </div>

                    <!-- æ–°å¯†ç  -->
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            æ–°å¯†ç 
                        </label>
                        <input type="password" id="newPassword" name="newPassword" autocomplete="new-password"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                               placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">å¯†ç é•¿åº¦è‡³å°‘6ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—</p>
                    </div>

                    <!-- ç¡®è®¤æ–°å¯†ç  -->
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            ç¡®è®¤æ–°å¯†ç 
                        </label>
                        <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                               placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                    </div>

                    <!-- é€šçŸ¥è®¾ç½® -->
                    <div class="pt-4 border-t border-gray-100 dark:border-gray-800">
                        <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">é€šçŸ¥è®¾ç½®</h4>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="emailNotifications" name="emailNotifications" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">æ¥æ”¶é‚®ä»¶é€šçŸ¥</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="browserNotifications" name="browserNotifications" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">æ¥æ”¶æµè§ˆå™¨é€šçŸ¥</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="studyReminders" name="studyReminders" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">å­¦ä¹ æé†’</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="profileMessage" class="mt-4"></div>
                
                <!-- æŒ‰é’®åŒº -->
                <div class="flex flex-col-reverse sm:flex-row gap-4 pt-6 border-t border-gray-100 dark:border-gray-800 flex-shrink-0">
                    <button type="button" id="deactivateAccountBtn" 
                            class="w-full sm:w-auto px-4 py-2 border border-red-300 dark:border-red-700 rounded-lg text-red-700 dark:text-red-300 bg-white dark:bg-gray-900 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors duration-200 font-medium">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        æ³¨é”€è´¦æˆ·
                    </button>
                    <button type="button" id="cancelProfileBtn" 
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200 font-medium">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" id="saveProfileBtn" 
                            class="w-full sm:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- æ³¨é”€ç¡®è®¤å¼¹çª— -->
<div id="deactivateModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm transition-all duration-300 hidden p-4">
    <div class="relative w-full mx-2 sm:mx-auto" style="max-width: 28rem; width: 100%;">
        <!-- å¼¹çª—ä¸»ä½“ -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl transition-all duration-300 scale-95 opacity-0">
            <!-- å¤´éƒ¨ -->
            <div class="flex items-center justify-between px-6 pt-6 pb-2 border-b border-gray-100 dark:border-gray-800">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">æ³¨é”€è´¦æˆ·</h3>
                </div>
                <button id="closeDeactivateModalBtn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                    <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- å†…å®¹åŒº -->
            <div class="px-6 py-6">
                <div class="space-y-4">
                    <!-- è­¦å‘Šä¿¡æ¯ -->
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                        <div class="flex">
                            <svg class="w-5 h-5 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-red-800 dark:text-red-200">é‡è¦æé†’</h4>
                                <p class="text-sm text-red-700 dark:text-red-300 mt-1">
                                    æ³¨é”€è´¦æˆ·åï¼Œæ‚¨çš„æ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼ŒåŒ…æ‹¬å­¦ä¹ è®°å½•ã€æˆå°±ã€ç§¯åˆ†ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- é‚®ç®±éªŒè¯ -->
                    <div id="emailVerificationSection">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            é‚®ç®±éªŒè¯ç  <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-2">
                            <input type="text" id="verificationCode" name="verificationCode" maxlength="6"
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                                   placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç ">
                            <button type="button" id="sendVerificationCodeBtn"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200">
                                å‘é€éªŒè¯ç 
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            éªŒè¯ç å°†å‘é€åˆ°æ‚¨çš„æ³¨å†Œé‚®ç®±ï¼Œç”¨äºç¡®è®¤æ³¨é”€æ“ä½œ
                        </p>
                    </div>

                    <!-- ç¡®è®¤è¾“å…¥ -->
                    <div>
                        <label for="confirmDeactivate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            ç¡®è®¤æ³¨é”€ <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="confirmDeactivate" name="confirmDeactivate"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                               placeholder="è¯·è¾“å…¥'æ³¨é”€è´¦æˆ·'ç¡®è®¤æ“ä½œ">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            è¯·è¾“å…¥"æ³¨é”€è´¦æˆ·"ä»¥ç¡®è®¤æ‚¨è¦æ³¨é”€è´¦æˆ·
                        </p>
                    </div>

                    <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="deactivateMessage" class="mt-4"></div>
                </div>

                <!-- æŒ‰é’®åŒº -->
                <div class="flex flex-col-reverse sm:flex-row gap-4 pt-6 border-t border-gray-100 dark:border-gray-800">
                    <button type="button" id="cancelDeactivateBtn"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200 font-medium">
                        å–æ¶ˆ
                    </button>
                    <button type="button" id="confirmDeactivateBtn"
                            class="w-full sm:w-auto px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        ç¡®è®¤æ³¨é”€
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ç”¨æˆ·ä¸‹æ‹‰èœå•åŠŸèƒ½
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdownMenu');
    if (dropdown) {
        const isVisible = dropdown.style.display !== 'none';
        dropdown.style.display = isVisible ? 'none' : 'block';
    }
}

function closeUserDropdown() {
    const dropdown = document.getElementById('userDropdownMenu');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// ä¸ªäººè®¾ç½®å¼¹çª—åŠŸèƒ½
function showProfileModal() {
    const modal = document.getElementById('profileModal');
    const modalContent = modal?.querySelector('.bg-white, .dark\\:bg-gray-900');
    
    if (modal && modalContent) {
        // é‡ç½®è¡¨å•
        const form = document.getElementById('profileForm');
        if (form) {
            form.reset();
        }
        
        // æ¸…é™¤æ¶ˆæ¯
        const messageDiv = document.getElementById('profileMessage');
        if (messageDiv) {
            messageDiv.innerHTML = '';
        }
        
        // æ˜¾ç¤ºå¼¹çª—
        modal.classList.remove('hidden');
        
        // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        // å…³é—­ç”¨æˆ·ä¸‹æ‹‰èœå•
        closeUserDropdown();
    }
}

function hideProfileModal() {
    const modal = document.getElementById('profileModal');
    const modalContent = modal?.querySelector('.bg-white, .dark\\:bg-gray-900');
    
    if (modal && modalContent) {
        // æ·»åŠ å…³é—­åŠ¨ç”»
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        
        // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—å¼¹çª—
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
}

// å†…å®¹åˆ‡æ¢åŠŸèƒ½
function showContent(contentType) {
    const dynamicContent = document.getElementById('dynamicContent');
    const pageTitle = document.getElementById('pageTitle');
    
    // æ ¹æ®å†…å®¹ç±»å‹è®¾ç½®æ ‡é¢˜
    const titles = {
        'dashboard': 'ä»ªè¡¨æ¿',
        'projects': 'é¡¹ç›®ç®¡ç†',
        'sessions': 'å­¦ä¹ è®°å½•',
        'analytics': 'æ•°æ®åˆ†æ',
        'notifications': 'é€šçŸ¥ä¸­å¿ƒ',
        'admin': 'ç³»ç»Ÿç®¡ç†'
    };
    pageTitle.textContent = titles[contentType] || 'å­¦ä¹ è¿½è¸ªç³»ç»Ÿ';
    
    // é€šè¿‡AJAXåŠ è½½å¯¹åº”é¡µé¢å†…å®¹ï¼Œèœå•åˆ‡æ¢æ—¶ä¸æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
    loadPageContent(contentType, false);
}

// åŠ è½½é¡µé¢å†…å®¹
async function loadPageContent(contentType, showSuccessNotification = true) {
    console.log('loadPageContent è¢«è°ƒç”¨ï¼ŒcontentType:', contentType, 'showSuccessNotification:', showSuccessNotification);
    console.log('è°ƒç”¨æ ˆ:', new Error().stack);
    
    const dynamicContent = document.getElementById('dynamicContent');
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        dynamicContent.innerHTML = `
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-primary-600 border-t-transparent mx-auto mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">æ­£åœ¨åŠ è½½...</p>
                </div>
            </div>
        `;
        
        // å‘é€AJAXè¯·æ±‚è·å–é¡µé¢å†…å®¹
        let requestUrl = `/${contentType}`;
        
        // å¤„ç†ç®¡ç†ç«¯é¡µé¢çš„è·¯ç”±æ˜ å°„
        if (contentType === 'admin-points-exchange') {
            requestUrl = '/admin/points-exchange';
        } else if (contentType === 'admin-exchange-approval') {
            requestUrl = '/admin/exchange-approval';
        }
        
        // Demoæ¨¡å¼ä¸‹æ·»åŠ å‰ç¼€
        if (window.isDemo) {
            requestUrl = '/demo' + requestUrl;
        }
        
        console.log('å‘é€ AJAX è¯·æ±‚åˆ°:', requestUrl);
        const response = await fetch(requestUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'text/html'
            },
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            const content = await response.text();
            console.log('é¡µé¢å†…å®¹åŠ è½½æˆåŠŸï¼Œé•¿åº¦:', content.length);
            dynamicContent.innerHTML = content;
            
            // æ›´æ–°æµè§ˆå™¨å†å²
            const url = window.isDemo ? `/demo/${contentType}` : `/${contentType}`;
            window.history.pushState({ contentType }, '', url);
            
            // æ‰§è¡Œé¡µé¢ç‰¹å®šçš„åˆå§‹åŒ–è„šæœ¬
            console.log('å‡†å¤‡æ‰§è¡Œé¡µé¢è„šæœ¬ï¼ŒcontentType:', contentType);
            executePageScripts(contentType);
            
            // åªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
            if (showSuccessNotification && window.showNotification) {
                window.showNotification('é¡µé¢åŠ è½½æˆåŠŸ', 'success', 2000);
            }
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('åŠ è½½é¡µé¢å†…å®¹å¤±è´¥:', error);
        dynamicContent.innerHTML = `
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="text-red-500 text-4xl mb-4">âŒ</div>
                    <p class="text-gray-600 dark:text-gray-400">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>
                    <button onclick="loadPageContent('${contentType}', true)" class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        é‡æ–°åŠ è½½
                    </button>
                </div>
            </div>
        `;
        
        if (window.showNotification) {
            window.showNotification('é¡µé¢åŠ è½½å¤±è´¥', 'error', 5000);
        }
    }
}

// æ‰§è¡Œé¡µé¢ç‰¹å®šçš„åˆå§‹åŒ–è„šæœ¬
function executePageScripts(contentType) {
    console.log('æ‰§è¡Œé¡µé¢è„šæœ¬:', contentType);
    
    switch(contentType) {
        case 'admin':
            // ç³»ç»Ÿç®¡ç†é¡µé¢åˆå§‹åŒ–
            loadAdminScript().then(() => {
                if (typeof initializeAdminPage === 'function') {
                    console.log('åˆå§‹åŒ–ç³»ç»Ÿç®¡ç†é¡µé¢...');
                    initializeAdminPage();
                } else {
                    console.error('initializeAdminPage å‡½æ•°æœªæ‰¾åˆ°');
                }
            }).catch(error => {
                console.error('åŠ è½½ admin.js å¤±è´¥:', error);
            });
            break;
        case 'dashboard':
            // ä»ªè¡¨æ¿é¡µé¢åˆå§‹åŒ–
            console.log('æ£€æµ‹åˆ° dashboard é¡µé¢ï¼Œå¼€å§‹åŠ è½½ dashboard.js...');
            if (!window.dashboardScriptLoaded) {
                // ç¡®ä¿Chart.jså·²åŠ è½½
                if (typeof Chart === 'undefined') {
                    console.log('Chart.js æœªåŠ è½½ï¼Œå…ˆåŠ è½½ Chart.js...');
                    const chartScript = document.createElement('script');
                    chartScript.src = '/assets/lib/chart.umd.min.js';
                    chartScript.onload = function() {
                        console.log('Chart.js åŠ è½½æˆåŠŸï¼Œç°åœ¨åŠ è½½ dashboard.js...');
                        loadDashboardScript();
                    };
                    chartScript.onerror = function() {
                        console.error('Chart.js åŠ è½½å¤±è´¥');
                        loadDashboardScript();
                    };
                    document.head.appendChild(chartScript);
                } else {
                    console.log('Chart.js å·²åŠ è½½ï¼Œç›´æ¥åŠ è½½ dashboard.js...');
                    loadDashboardScript();
                }
            } else {
                if (typeof initializeDashboard === 'function') {
                    initializeDashboard();
                }
            }
            break;
        case 'projects':
            // é¡¹ç›®ç®¡ç†é¡µé¢åˆå§‹åŒ–
            console.log('åˆå§‹åŒ–é¡¹ç›®ç®¡ç†é¡µé¢...');
            
            // ç¡®ä¿Chart.jså·²åŠ è½½
            if (typeof Chart === 'undefined') {
                console.log('Chart.js æœªåŠ è½½ï¼Œå…ˆåŠ è½½ Chart.js...');
                const chartScript = document.createElement('script');
                chartScript.src = '/assets/lib/chart.umd.min.js';
                chartScript.onload = function() {
                    console.log('Chart.js åŠ è½½æˆåŠŸï¼Œç°åœ¨æ‰§è¡Œé¡µé¢è„šæœ¬...');
                    executeProjectScripts();
                };
                chartScript.onerror = function() {
                    console.error('Chart.js åŠ è½½å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œé¡µé¢è„šæœ¬...');
                    executeProjectScripts();
                };
                document.head.appendChild(chartScript);
            } else {
                console.log('Chart.js å·²åŠ è½½ï¼Œç›´æ¥æ‰§è¡Œé¡µé¢è„šæœ¬...');
                executeProjectScripts();
            }
            break;
        case 'sessions':
            // å­¦ä¹ è®°å½•é¡µé¢åˆå§‹åŒ– - éœ€è¦æ‰‹åŠ¨åŠ è½½ sessions.js
            console.log('åˆå§‹åŒ–å­¦ä¹ è®°å½•é¡µé¢...');
            if (typeof SessionsManager !== 'undefined') {
                // å¦‚æœ SessionsManager å·²å­˜åœ¨ï¼Œç›´æ¥åˆå§‹åŒ–
                if (window.sessionsManager) {
                    console.log('æ¸…ç†ç°æœ‰ SessionsManager å®ä¾‹');
                    // æ¸…ç†ç°æœ‰å®ä¾‹
                    if (window.sessionsManager.handleEscapeKey) {
                        document.removeEventListener('keydown', window.sessionsManager.handleEscapeKey);
                    }
                    window.sessionsManager = null;
                }
                console.log('åˆ›å»ºæ–°çš„ SessionsManager å®ä¾‹');
                window.sessionsManager = new SessionsManager();
            } else {
                console.log('SessionsManager æœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨åŠ è½½ sessions.js...');
                loadSessionsScript().then(() => {
                    if (typeof SessionsManager !== 'undefined') {
                        console.log('åˆ›å»ºæ–°çš„ SessionsManager å®ä¾‹');
                        window.sessionsManager = new SessionsManager();
                    } else {
                        console.error('SessionsManager ä»ç„¶æœªæ‰¾åˆ°');
                    }
                }).catch(error => {
                    console.error('åŠ è½½ sessions.js å¤±è´¥:', error);
                });
            }
            break;
        case 'analytics':
            // æ•°æ®åˆ†æé¡µé¢åˆå§‹åŒ–
            if (typeof initializeAnalytics === 'function') {
                console.log('åˆå§‹åŒ–æ•°æ®åˆ†æé¡µé¢...');
                initializeAnalytics();
            }
            break;
        case 'notifications':
            // é€šçŸ¥ä¸­å¿ƒé¡µé¢åˆå§‹åŒ–
            console.log('åˆå§‹åŒ–é€šçŸ¥ä¸­å¿ƒé¡µé¢...');
            // é€šçŸ¥é¡µé¢çš„ JS åœ¨ç‹¬ç«‹çš„ notifications.js æ–‡ä»¶ä¸­
            executeNotificationScripts();
            break;
        case 'achievements':
            // æˆå°±é¡µé¢åˆå§‹åŒ–
            console.log('åˆå§‹åŒ–æˆå°±é¡µé¢...');
            // æˆå°±é¡µé¢çš„ JS å·²ç»å†…åµŒåœ¨é¡µé¢ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ
            executeAchievementScripts();
            break;
        case 'admin-points-exchange':
            // ç§¯åˆ†å…‘æ¢ç®¡ç†é¡µé¢åˆå§‹åŒ–
            console.log('åˆå§‹åŒ–ç§¯åˆ†å…‘æ¢ç®¡ç†é¡µé¢...');
            // ç§¯åˆ†å…‘æ¢ç®¡ç†é¡µé¢çš„ JS å·²ç»å†…åµŒåœ¨é¡µé¢ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ
            executeAdminPointsExchangeScripts();
            break;
        case 'admin-exchange-approval':
            // å…‘æ¢å®¡æ ¸é¡µé¢åˆå§‹åŒ–
            console.log('åˆå§‹åŒ–å…‘æ¢å®¡æ ¸é¡µé¢...');
            // å…‘æ¢å®¡æ ¸é¡µé¢çš„ JS å·²ç»å†…åµŒåœ¨é¡µé¢ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ
            executeAdminExchangeApprovalScripts();
            break;
        default:
            console.log('æ²¡æœ‰ç‰¹å®šçš„åˆå§‹åŒ–è„šæœ¬:', contentType);
    }
}

// æ‰§è¡Œé¡¹ç›®ç®¡ç†é¡µé¢è„šæœ¬
function executeProjectScripts() {
    console.log('æ‰§è¡Œé¡¹ç›®ç®¡ç†é¡µé¢è„šæœ¬...');
    
    // æŸ¥æ‰¾é¡µé¢ä¸­çš„scriptæ ‡ç­¾å¹¶æ‰§è¡Œ
    const projectScripts = document.querySelectorAll('#dynamicContent script');
    console.log('æ‰¾åˆ°çš„scriptæ ‡ç­¾æ•°é‡:', projectScripts.length);
    
    // åªæ‰§è¡Œä¸€æ¬¡è„šæœ¬æ ‡ç­¾
    projectScripts.forEach((script, index) => {
        console.log(`æ‰§è¡Œç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾`);
        try {
            // åˆ›å»ºæ–°çš„scriptå…ƒç´ å¹¶æ‰§è¡Œ
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            document.head.appendChild(newScript);
            console.log(`ç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾æ‰§è¡Œå®Œæˆ`);
        } catch (error) {
            console.error(`æ‰§è¡Œç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾å¤±è´¥:`, error);
        }
    });
    
    // ç­‰å¾…ä¸€ä¸‹è®©è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œç„¶åæ£€æŸ¥initializeProjectså‡½æ•°
    setTimeout(() => {
        console.log('æ£€æŸ¥ProjectsAppæ˜¯å¦å·²å®šä¹‰:', typeof ProjectsApp);
        console.log('æ£€æŸ¥initializeProjectsæ˜¯å¦å·²å®šä¹‰:', typeof initializeProjects);
        
        if (typeof ProjectsApp === 'undefined') {
            console.error('ProjectsApp ç±»æœªå®šä¹‰ï¼Œä½†ä¸å†é‡å¤æ‰§è¡Œè„šæœ¬');
        } else if (typeof initializeProjects === 'function') {
            console.log('è°ƒç”¨ initializeProjects å‡½æ•°');
            initializeProjects();
        } else {
            console.error('initializeProjects å‡½æ•°æœªæ‰¾åˆ°');
        }
    }, 100);
}

// æ‰§è¡Œæˆå°±é¡µé¢è„šæœ¬
function executeAchievementScripts() {
    console.log('æ‰§è¡Œæˆå°±é¡µé¢è„šæœ¬...');
    
    // æŸ¥æ‰¾é¡µé¢ä¸­çš„scriptæ ‡ç­¾å¹¶æ‰§è¡Œ
    const achievementScripts = document.querySelectorAll('#dynamicContent script');
    console.log('æ‰¾åˆ°çš„scriptæ ‡ç­¾æ•°é‡:', achievementScripts.length);
    
    // åªæ‰§è¡Œä¸€æ¬¡è„šæœ¬æ ‡ç­¾
    achievementScripts.forEach((script, index) => {
        console.log(`æ‰§è¡Œç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾`);
        try {
            // åˆ›å»ºæ–°çš„scriptå…ƒç´ å¹¶æ‰§è¡Œ
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            document.head.appendChild(newScript);
            console.log(`ç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾æ‰§è¡Œå®Œæˆ`);
        } catch (error) {
            console.error(`æ‰§è¡Œç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾å¤±è´¥:`, error);
        }
    });
    
    // ç­‰å¾…ä¸€ä¸‹è®©è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œç„¶åæ£€æŸ¥AchievementPageç±»
    setTimeout(() => {
        console.log('æ£€æŸ¥AchievementPageæ˜¯å¦å·²å®šä¹‰:', typeof AchievementPage);
        
        if (typeof AchievementPage === 'undefined') {
            console.error('AchievementPage ç±»æœªå®šä¹‰');
        } else {
            console.log('AchievementPage ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å®ä¾‹
                if (window.achievementPage) {
                    console.log('æ¸…ç†ç°æœ‰ AchievementPage å®ä¾‹');
                    window.achievementPage = null;
                }
                
                // åˆ›å»ºæ–°å®ä¾‹
                window.achievementPage = new AchievementPage();
                console.log('AchievementPage å®ä¾‹åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('åˆ›å»º AchievementPage å®ä¾‹å¤±è´¥:', error);
            }
        }
    }, 100);
}

// æ‰§è¡Œé€šçŸ¥é¡µé¢è„šæœ¬
function executeNotificationScripts() {
    console.log('æ‰§è¡Œé€šçŸ¥é¡µé¢è„šæœ¬...');
    
    // æŸ¥æ‰¾é¡µé¢ä¸­çš„scriptæ ‡ç­¾å¹¶æ‰§è¡Œ
    const notificationScripts = document.querySelectorAll('#dynamicContent script');
    console.log('æ‰¾åˆ°çš„scriptæ ‡ç­¾æ•°é‡:', notificationScripts.length);
    
    // åªæ‰§è¡Œä¸€æ¬¡è„šæœ¬æ ‡ç­¾
    notificationScripts.forEach((script, index) => {
        console.log(`æ‰§è¡Œç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾`);
        try {
            // åˆ›å»ºæ–°çš„scriptå…ƒç´ å¹¶æ‰§è¡Œ
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            document.head.appendChild(newScript);
            console.log(`ç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾æ‰§è¡Œå®Œæˆ`);
        } catch (error) {
            console.error(`æ‰§è¡Œç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾å¤±è´¥:`, error);
        }
    });
    
    // ç­‰å¾…ä¸€ä¸‹è®©è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œç„¶åæ£€æŸ¥NotificationsPageç±»
    setTimeout(() => {
        console.log('æ£€æŸ¥NotificationsPageæ˜¯å¦å·²å®šä¹‰:', typeof NotificationsPage);
        
        if (typeof NotificationsPage === 'undefined') {
            console.error('NotificationsPage ç±»æœªå®šä¹‰ï¼Œå°è¯•åŠ è½½ notifications.js');
            // å°è¯•åŠ è½½ notifications.js æ–‡ä»¶
            loadExternalScript('/assets/js/notifications.js').then(() => {
                console.log('notifications.js åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ NotificationsPage ç±»');
                if (typeof NotificationsPage !== 'undefined') {
                    console.log('NotificationsPage ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
                    try {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å®ä¾‹
                        if (window.notificationsPage) {
                            console.log('æ¸…ç†ç°æœ‰ NotificationsPage å®ä¾‹');
                            window.notificationsPage = null;
                        }
                        
                        // åˆ›å»ºæ–°å®ä¾‹
                        window.notificationsPage = new NotificationsPage();
                        console.log('NotificationsPage å®ä¾‹åˆ›å»ºæˆåŠŸ');
                    } catch (error) {
                        console.error('åˆ›å»º NotificationsPage å®ä¾‹å¤±è´¥:', error);
                    }
                } else {
                    console.error('NotificationsPage ç±»ä»ç„¶æœªå®šä¹‰');
                }
            }).catch(error => {
                console.error('åŠ è½½ notifications.js å¤±è´¥:', error);
            });
        } else {
            console.log('NotificationsPage ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å®ä¾‹
                if (window.notificationsPage) {
                    console.log('æ¸…ç†ç°æœ‰ NotificationsPage å®ä¾‹');
                    window.notificationsPage = null;
                }
                
                // åˆ›å»ºæ–°å®ä¾‹
                window.notificationsPage = new NotificationsPage();
                console.log('NotificationsPage å®ä¾‹åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('åˆ›å»º NotificationsPage å®ä¾‹å¤±è´¥:', error);
            }
        }
    }, 100);
}

// åŠ è½½å¤–éƒ¨JavaScriptæ–‡ä»¶çš„è¾…åŠ©å‡½æ•°
function loadExternalScript(src, callback) {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡
        const existingScript = document.querySelector(`script[src="${src}"]`);
        if (existingScript) {
            console.log(`è„šæœ¬å·²å­˜åœ¨: ${src}`);
            if (callback) callback();
            resolve();
            return;
        }
        
        console.log(`åŠ è½½å¤–éƒ¨è„šæœ¬: ${src}`);
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
            console.log(`å¤–éƒ¨è„šæœ¬åŠ è½½å®Œæˆ: ${src}`);
            if (callback) callback();
            resolve();
        };
        script.onerror = () => {
            console.error(`å¤–éƒ¨è„šæœ¬åŠ è½½å¤±è´¥: ${src}`);
            reject(new Error(`Failed to load ${src}`));
        };
        document.head.appendChild(script);
    });
}

// æ‰§è¡Œç§¯åˆ†å…‘æ¢ç®¡ç†é¡µé¢è„šæœ¬
function executeAdminPointsExchangeScripts() {
    console.log('æ‰§è¡Œç§¯åˆ†å…‘æ¢ç®¡ç†é¡µé¢è„šæœ¬...');
    
    // æŸ¥æ‰¾é¡µé¢ä¸­çš„scriptæ ‡ç­¾å¹¶æ‰§è¡Œ
    const scripts = document.querySelectorAll('#dynamicContent script');
    console.log('æ‰¾åˆ°çš„scriptæ ‡ç­¾æ•°é‡:', scripts.length);
    
    // å¤„ç†è„šæœ¬æ ‡ç­¾
    scripts.forEach((script, index) => {
        console.log(`å¤„ç†ç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾`);
        
        if (script.src) {
            // å¤–éƒ¨JavaScriptæ–‡ä»¶
            console.log(`åŠ è½½å¤–éƒ¨è„šæœ¬: ${script.src}`);
            loadExternalScript(script.src, () => {
                console.log(`å¤–éƒ¨è„šæœ¬åŠ è½½å®Œæˆ: ${script.src}`);
                // æ£€æŸ¥AdminPointsExchangeç±»æ˜¯å¦å·²å®šä¹‰
                setTimeout(() => {
                    console.log('æ£€æŸ¥AdminPointsExchangeæ˜¯å¦å·²å®šä¹‰:', typeof AdminPointsExchange);
                    
                    if (typeof AdminPointsExchange !== 'undefined') {
                        console.log('AdminPointsExchange ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
                        try {
                            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å®ä¾‹
                            if (window.adminPointsExchange) {
                                console.log('æ¸…ç†ç°æœ‰ AdminPointsExchange å®ä¾‹');
                                window.adminPointsExchange = null;
                            }
                            
                            // åˆ›å»ºæ–°å®ä¾‹
                            window.adminPointsExchange = new AdminPointsExchange();
                            console.log('AdminPointsExchange å®ä¾‹åˆ›å»ºæˆåŠŸ');
                        } catch (error) {
                            console.error('åˆ›å»º AdminPointsExchange å®ä¾‹å¤±è´¥:', error);
                        }
                    } else {
                        console.error('AdminPointsExchange ç±»ä»æœªå®šä¹‰');
                    }
                }, 100);
            });
        } else {
            // å†…è”è„šæœ¬
            try {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.head.appendChild(newScript);
                console.log(`ç¬¬${index + 1}ä¸ªå†…è”è„šæœ¬æ‰§è¡Œå®Œæˆ`);
            } catch (error) {
                console.error(`æ‰§è¡Œç¬¬${index + 1}ä¸ªå†…è”è„šæœ¬å¤±è´¥:`, error);
            }
        }
    });
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è„šæœ¬æ ‡ç­¾ï¼Œå°è¯•æ‰‹åŠ¨åŠ è½½
    if (scripts.length === 0) {
        console.log('æœªæ‰¾åˆ°è„šæœ¬æ ‡ç­¾ï¼Œå°è¯•æ‰‹åŠ¨åŠ è½½admin-points-exchange.js');
        loadExternalScript('/assets/js/admin-points-exchange.js', () => {
            console.log('æ‰‹åŠ¨åŠ è½½admin-points-exchange.jså®Œæˆ');
            setTimeout(() => {
                console.log('æ£€æŸ¥AdminPointsExchangeæ˜¯å¦å·²å®šä¹‰:', typeof AdminPointsExchange);
                
                if (typeof AdminPointsExchange !== 'undefined') {
                    console.log('AdminPointsExchange ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
                    try {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å®ä¾‹
                        if (window.adminPointsExchange) {
                            console.log('æ¸…ç†ç°æœ‰ AdminPointsExchange å®ä¾‹');
                            window.adminPointsExchange = null;
                        }
                        
                        // åˆ›å»ºæ–°å®ä¾‹
                        window.adminPointsExchange = new AdminPointsExchange();
                        console.log('AdminPointsExchange å®ä¾‹åˆ›å»ºæˆåŠŸ');
                    } catch (error) {
                        console.error('åˆ›å»º AdminPointsExchange å®ä¾‹å¤±è´¥:', error);
                    }
                } else {
                    console.error('AdminPointsExchange ç±»ä»æœªå®šä¹‰');
                }
            }, 100);
        });
    }
}

// æ‰§è¡Œå…‘æ¢å®¡æ ¸é¡µé¢è„šæœ¬
function executeAdminExchangeApprovalScripts() {
    console.log('æ‰§è¡Œå…‘æ¢å®¡æ ¸é¡µé¢è„šæœ¬...');
    
    // æŸ¥æ‰¾é¡µé¢ä¸­çš„scriptæ ‡ç­¾å¹¶æ‰§è¡Œ
    const scripts = document.querySelectorAll('#dynamicContent script');
    console.log('æ‰¾åˆ°çš„scriptæ ‡ç­¾æ•°é‡:', scripts.length);
    
    // å¤„ç†è„šæœ¬æ ‡ç­¾
    scripts.forEach((script, index) => {
        console.log(`å¤„ç†ç¬¬${index + 1}ä¸ªscriptæ ‡ç­¾`);
        
        if (script.src) {
            // å¤–éƒ¨JavaScriptæ–‡ä»¶
            console.log(`åŠ è½½å¤–éƒ¨è„šæœ¬: ${script.src}`);
            loadExternalScript(script.src, () => {
                console.log(`å¤–éƒ¨è„šæœ¬åŠ è½½å®Œæˆ: ${script.src}`);
                // æ£€æŸ¥AdminExchangeApprovalç±»æ˜¯å¦å·²å®šä¹‰
                setTimeout(() => {
                    console.log('æ£€æŸ¥AdminExchangeApprovalæ˜¯å¦å·²å®šä¹‰:', typeof AdminExchangeApproval);
                    
                    if (typeof AdminExchangeApproval !== 'undefined') {
                        console.log('AdminExchangeApproval ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
                        try {
                            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å®ä¾‹
                            if (window.adminExchangeApproval) {
                                console.log('æ¸…ç†ç°æœ‰ AdminExchangeApproval å®ä¾‹');
                                window.adminExchangeApproval = null;
                            }
                            
                            // åˆ›å»ºæ–°å®ä¾‹å¹¶åˆå§‹åŒ–
                            window.adminExchangeApproval = new AdminExchangeApproval();
                            window.adminExchangeApproval.init();
                            console.log('AdminExchangeApproval å®ä¾‹åˆ›å»ºå¹¶åˆå§‹åŒ–æˆåŠŸ');
                        } catch (error) {
                            console.error('åˆ›å»º AdminExchangeApproval å®ä¾‹å¤±è´¥:', error);
                        }
                    } else {
                        console.error('AdminExchangeApproval ç±»ä»æœªå®šä¹‰');
                    }
                }, 100);
            });
        } else {
            // å†…è”è„šæœ¬
            try {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.head.appendChild(newScript);
                console.log(`ç¬¬${index + 1}ä¸ªå†…è”è„šæœ¬æ‰§è¡Œå®Œæˆ`);
            } catch (error) {
                console.error(`æ‰§è¡Œç¬¬${index + 1}ä¸ªå†…è”è„šæœ¬å¤±è´¥:`, error);
            }
        }
    });
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è„šæœ¬æ ‡ç­¾ï¼Œå°è¯•æ‰‹åŠ¨åŠ è½½
    if (scripts.length === 0) {
        console.log('æœªæ‰¾åˆ°è„šæœ¬æ ‡ç­¾ï¼Œå°è¯•æ‰‹åŠ¨åŠ è½½admin-exchange-approval.js');
        loadExternalScript('/assets/js/admin-exchange-approval.js', () => {
            console.log('æ‰‹åŠ¨åŠ è½½admin-exchange-approval.jså®Œæˆ');
            setTimeout(() => {
                console.log('æ£€æŸ¥AdminExchangeApprovalæ˜¯å¦å·²å®šä¹‰:', typeof AdminExchangeApproval);
                
                if (typeof AdminExchangeApproval !== 'undefined') {
                    console.log('AdminExchangeApproval ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
                    try {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å®ä¾‹
                        if (window.adminExchangeApproval) {
                            console.log('æ¸…ç†ç°æœ‰ AdminExchangeApproval å®ä¾‹');
                            window.adminExchangeApproval = null;
                        }
                        
                        // åˆ›å»ºæ–°å®ä¾‹å¹¶åˆå§‹åŒ–
                        window.adminExchangeApproval = new AdminExchangeApproval();
                        window.adminExchangeApproval.init();
                        console.log('AdminExchangeApproval å®ä¾‹åˆ›å»ºå¹¶åˆå§‹åŒ–æˆåŠŸ');
                    } catch (error) {
                        console.error('åˆ›å»º AdminExchangeApproval å®ä¾‹å¤±è´¥:', error);
                    }
                } else {
                    console.error('AdminExchangeApproval ç±»ä»æœªå®šä¹‰');
                    // æ·»åŠ é‡è¯•æœºåˆ¶
                    setTimeout(() => {
                        console.log('é‡è¯•æ£€æŸ¥AdminExchangeApprovalæ˜¯å¦å·²å®šä¹‰:', typeof AdminExchangeApproval);
                        if (typeof AdminExchangeApproval !== 'undefined') {
                            console.log('AdminExchangeApproval ç±»å·²å®šä¹‰ï¼Œå°è¯•åˆ›å»ºå®ä¾‹');
                            try {
                                if (window.adminExchangeApproval) {
                                    console.log('æ¸…ç†ç°æœ‰ AdminExchangeApproval å®ä¾‹');
                                    window.adminExchangeApproval = null;
                                }
                                window.adminExchangeApproval = new AdminExchangeApproval();
                                window.adminExchangeApproval.init();
                                console.log('AdminExchangeApproval å®ä¾‹åˆ›å»ºå¹¶åˆå§‹åŒ–æˆåŠŸ');
                            } catch (error) {
                                console.error('åˆ›å»º AdminExchangeApproval å®ä¾‹å¤±è´¥:', error);
                            }
                        } else {
                            console.error('AdminExchangeApproval ç±»ä»ç„¶æœªå®šä¹‰ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–è¯­æ³•é”™è¯¯');
                        }
                    }, 500);
                }
            }, 100);
        });
    }
}

// åŠ¨æ€åŠ è½½ dashboard.js è„šæœ¬
function loadDashboardScript() {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡
        if (typeof initializeDashboard === 'function') {
            console.log('dashboard.js å·²ç»åŠ è½½');
            resolve();
            return;
        }
        
        console.log('åŠ¨æ€åŠ è½½ dashboard.js...');
        const script = document.createElement('script');
        script.src = '/assets/js/dashboard.js';
        script.onload = () => {
            console.log('dashboard.js åŠ è½½æˆåŠŸ');
            window.dashboardScriptLoaded = true;
            if (typeof initializeDashboard === 'function') {
                initializeDashboard();
            }
            resolve();
        };
        script.onerror = () => {
            console.error('dashboard.js åŠ è½½å¤±è´¥');
            reject(new Error('Failed to load dashboard.js'));
        };
        document.head.appendChild(script);
    });
}

// åŠ¨æ€åŠ è½½ admin.js è„šæœ¬
function loadAdminScript() {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡
        if (typeof initializeAdminPage === 'function') {
            console.log('admin.js å·²ç»åŠ è½½');
            resolve();
            return;
        }
        
        console.log('åŠ¨æ€åŠ è½½ admin.js...');
        const script = document.createElement('script');
        script.src = '/assets/js/admin.js';
        script.onload = () => {
            console.log('admin.js åŠ è½½æˆåŠŸ');
            resolve();
        };
        script.onerror = () => {
            console.error('admin.js åŠ è½½å¤±è´¥');
            reject(new Error('Failed to load admin.js'));
        };
        document.head.appendChild(script);
    });
}

// åŠ¨æ€åŠ è½½ sessions.js è„šæœ¬
function loadSessionsScript() {
    return new Promise((resolve, reject) => {
        console.log('åŠ¨æ€åŠ è½½ sessions.js...');
        const script = document.createElement('script');
        script.src = '/assets/js/sessions.js';
        script.onload = () => {
            console.log('sessions.js åŠ è½½æˆåŠŸ');
            resolve();
        };
        script.onerror = () => {
            console.error('sessions.js åŠ è½½å¤±è´¥');
            reject(new Error('Failed to load sessions.js'));
        };
        document.head.appendChild(script);
    });
}

// äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    // å…³é—­æŒ‰é’®
    const closeBtn = document.getElementById('closeMobileMenu');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeMobileMenu);
    }
    
    // é®ç½©å±‚ç‚¹å‡»å…³é—­
    const overlay = document.getElementById('mobileSidebarOverlay');
    if (overlay) {
        overlay.addEventListener('click', closeMobileMenu);
    }
    
    // å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', handleNavClick);
    });
    
    // ç§»åŠ¨ç«¯èœå•æŒ‰é’®äº‹ä»¶ï¼ˆåœ¨main-content.hbsä¸­å¤„ç†ï¼‰
    const mobileMenuButton = document.getElementById('mobileMenuButton');
    if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', openMobileMenu);
    }
    
    // ç”¨æˆ·ä¸‹æ‹‰èœå•äº‹ä»¶
    const userDropdownButton = document.getElementById('userDropdownButton');
    const userDropdownMenu = document.getElementById('userDropdownMenu');
    
    if (userDropdownButton && userDropdownMenu) {
        userDropdownButton.addEventListener('click', toggleUserDropdown);
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(e) {
            if (!userDropdownButton.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                closeUserDropdown();
            }
        });
    }
    
    // ä¸ªäººè®¾ç½®å¼¹çª—äº‹ä»¶
    // æ³¨æ„ï¼šè¿™äº›äº‹ä»¶å·²ç»åœ¨ main.hbs çš„ initProfileModal å‡½æ•°ä¸­å¤„ç†
    // è¿™é‡Œä¸å†é‡å¤ç»‘å®šï¼Œé¿å…å†²çª
    
    // é‡æ–°æ·»åŠ åŸºæœ¬çš„å¼¹çª—æ˜¾ç¤º/éšè—åŠŸèƒ½
    const openProfileModalBtn = document.getElementById('openProfileModalBtn');
    const closeProfileModalBtn = document.getElementById('closeProfileModalBtn');
    const cancelProfileBtn = document.getElementById('cancelProfileBtn');
    
    console.log('ä¸ªäººè®¾ç½®å¼¹çª—äº‹ä»¶ç»‘å®šæ£€æŸ¥:');
    console.log('openProfileModalBtn:', openProfileModalBtn);
    console.log('closeProfileModalBtn:', closeProfileModalBtn);
    console.log('cancelProfileBtn:', cancelProfileBtn);
    
    if (openProfileModalBtn) {
        openProfileModalBtn.addEventListener('click', showProfileModal);
        console.log('ä¸ªäººè®¾ç½®æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
    
    if (closeProfileModalBtn) {
        closeProfileModalBtn.addEventListener('click', hideProfileModal);
        console.log('å…³é—­æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
    
    if (cancelProfileBtn) {
        cancelProfileBtn.addEventListener('click', hideProfileModal);
        console.log('å–æ¶ˆæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
    
    // æ³¨é”€å¼¹çª—äº‹ä»¶ç»‘å®š
    const closeDeactivateModalBtn = document.getElementById('closeDeactivateModalBtn');
    const cancelDeactivateBtn = document.getElementById('cancelDeactivateBtn');
    const sendVerificationCodeBtn = document.getElementById('sendVerificationCodeBtn');
    const confirmDeactivateBtn = document.getElementById('confirmDeactivateBtn');
    
    if (closeDeactivateModalBtn) {
        closeDeactivateModalBtn.addEventListener('click', hideDeactivateModal);
        console.log('å…³é—­æ³¨é”€å¼¹çª—æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
    
    if (cancelDeactivateBtn) {
        cancelDeactivateBtn.addEventListener('click', hideDeactivateModal);
        console.log('å–æ¶ˆæ³¨é”€æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
    
    if (sendVerificationCodeBtn) {
        sendVerificationCodeBtn.addEventListener('click', sendVerificationCode);
        console.log('å‘é€éªŒè¯ç æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
    
    if (confirmDeactivateBtn) {
        confirmDeactivateBtn.addEventListener('click', confirmDeactivate);
        console.log('ç¡®è®¤æ³¨é”€æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    const deactivateModal = document.getElementById('deactivateModal');
    if (deactivateModal) {
        deactivateModal.addEventListener('click', (e) => {
            if (e.target === deactivateModal) {
                hideDeactivateModal();
            }
        });
    }
    
    // è¡¨å•æäº¤åŠŸèƒ½
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
            
            const submitBtn = document.getElementById('saveProfileBtn');
            const messageDiv = document.getElementById('profileMessage');
            const originalText = submitBtn.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.innerHTML = `
                <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ä¿å­˜ä¸­...
            `;
            submitBtn.disabled = true;

            try {
                const formData = new FormData(profileForm);
                const data = Object.fromEntries(formData);
                
                // è·å–è®¤è¯token
                const token = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('token='))
                    ?.split('=')[1];
                
                if (!token) {
                    messageDiv.innerHTML = `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                            <p class="text-sm">ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</p>
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }
                
                const response = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = `
                        <div class="p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 dark:bg-green-900/20 dark:border-green-800 dark:text-green-400">
                            <p class="text-sm">${result.message || 'è®¾ç½®ä¿å­˜æˆåŠŸï¼'}</p>
                        </div>
                    `;
                    
                    // æ›´æ–°é¡µé¢ä¸Šçš„ç”¨æˆ·åæ˜¾ç¤º
                    const usernameElements = document.querySelectorAll('[data-username]');
                    usernameElements.forEach(el => {
                        el.textContent = data.username;
                    });
                    
                    // 3ç§’åå…³é—­å¼¹çª—
                    setTimeout(hideProfileModal, 3000);
                } else if (response.status === 401 || response.status === 403) {
                    // è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤cookieå¹¶é‡å®šå‘
                    messageDiv.innerHTML = `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                            <p class="text-sm">ç™»å½•å·²è¿‡æœŸï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...</p>
                        </div>
                    `;
                    document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                            <p class="text-sm">${result.error || 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                messageDiv.innerHTML = `
                    <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                        <p class="text-sm">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</p>
                    </div>
                `;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        console.log('è¡¨å•æäº¤äº‹ä»¶å·²ç»‘å®š');
    }
    
    // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
    const desktopDarkModeToggle = document.getElementById('desktopDarkModeToggle');
    const mobileDarkModeToggle = document.getElementById('mobileDarkModeToggle');
    
    if (desktopDarkModeToggle) {
        desktopDarkModeToggle.addEventListener('click', window.toggleDarkMode);
    }
    
    if (mobileDarkModeToggle) {
        mobileDarkModeToggle.addEventListener('click', window.toggleDarkMode);
    }
    
    // åˆå§‹åŒ–ä¸»é¢˜å›¾æ ‡
    const isDark = document.documentElement.classList.contains('dark');
    if (window.updateDarkModeIcons) {
        window.updateDarkModeIcons(isDark);
    }

    // æµè§ˆå™¨å‰è¿›åé€€å¤„ç†
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.contentType) {
            showContent(event.state.contentType);
        } else {
            showContent('dashboard');
        }
    });
});
</script> 